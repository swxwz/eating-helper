<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-select { -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color: transparent; }
    .fade-in-up { animation: fadeInUp 0.4s ease-out; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans no-select">

  <header id="topHeader" class="hidden sticky top-0 z-30 bg-white/95 backdrop-blur border-b">
    <div class="px-4 pt-3 pb-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ç”¨é¤è§‰å¯Ÿè®°å½•</div>
        <button id="toggleLogBtn" class="text-sm text-orange-600 font-medium btn-bounce px-3 py-2 rounded-lg">æŠ˜å </button>
      </div>
      <div id="recordLog" class="mt-2 max-h-32 overflow-y-auto text-sm text-gray-600">
        <ul id="logList" class="space-y-1"></ul>
        <div id="logEmpty" class="text-gray-400 py-2 italic text-xs text-center">æ­£åœ¨è†å¬èº«ä½“çš„å£°éŸ³...</div>
      </div>
    </div>
  </header>

  <main class="px-5 pt-6 pb-28">
    <section id="startScreen" class="text-center space-y-8 pt-16">
      <div class="text-8xl">ğŸ±</div>
      <div class="space-y-3">
        <h1 class="text-3xl font-black text-gray-900">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</h1>
        <p class="text-gray-500 text-sm leading-relaxed px-10">
          ç›®æ ‡ï¼š<span class="text-orange-600 font-bold">7æˆé¥±</span><br/>
          å®šæ—¶æé†’ï¼Œé™ªä½ ç”¨å¿ƒæ„Ÿå—æ¯ä¸€å£
        </p>
      </div>
      <button id="startBtn" class="btn-bounce bg-orange-500 text-white w-64 h-20 mx-auto rounded-full text-xl font-black shadow-xl shadow-orange-100">
        å¼€å§‹åƒé¥­
      </button>
    </section>

    <section id="eatingScreen" class="hidden text-center space-y-8">
      <div id="timerDisplay" class="font-mono text-5xl font-extralight text-orange-300">00:00</div>
      <div class="relative w-48 h-48 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-7xl animate-bounce duration-[2000ms]">ğŸ¥¢</div>
      </div>
      <div id="statusBanner" class="hidden mx-auto max-w-sm rounded-3xl border-2 border-orange-50 bg-white p-6 shadow-sm text-left fade-in-up">
        <div id="statusTitle" class="text-orange-600 font-black text-base"></div>
        <div id="statusText" class="mt-1 text-sm font-medium text-gray-600 leading-relaxed"></div>
      </div>
    </section>

    <section id="overfullScreen" class="hidden text-center space-y-8 pt-10">
      <div class="text-8xl animate-pulse">âš ï¸</div>
      <div class="space-y-4">
        <div class="text-3xl font-black text-gray-900 italic">è¶…çº§è¿‡é‡</div>
        <p class="text-gray-700 text-lg font-medium leading-relaxed">
          è¯·ç«‹å³åœæ­¢è¿›é£Ÿï¼Œæ·±å‘¼å¸ã€‚<br/>èº«ä½“éœ€è¦ä½ çš„ç…§é¡¾è€Œéè´Ÿæ‹…ã€‚
        </p>
      </div>
    </section>

    <section id="endTransitionScreen" class="hidden text-center space-y-10 pt-20">
      <div class="text-8xl">âœ¨</div>
      <div class="space-y-4">
        <div class="text-2xl font-black text-gray-900">è¿™ä¸€é¤è¾›è‹¦äº†</div>
        <div id="endTransitionText" class="text-orange-600 text-2xl font-black italic"></div>
        <p class="text-gray-400 text-sm italic">æ„¿ä½ æ¥ä¸‹æ¥çš„æ—¶å…‰è½»ç›ˆèˆ’é€‚</p>
      </div>
    </section>
  </main>

  <div id="choiceSheet" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-[2.5rem] shadow-2xl safe-bottom p-6">
        <div class="text-xl font-black text-gray-900 mb-6 px-2">ğŸ¥˜ ä½ ç°åœ¨å‡ æˆé¥±äº†ï¼Ÿ</div>
        <div id="optionsContainer" class="grid grid-cols-1 gap-3 max-h-[45vh] overflow-y-auto"></div>
        <div id="sheetEndWrap" class="hidden mt-6 pt-4 border-t border-gray-100">
           <button id="sheetEndBtn" class="relative overflow-hidden w-full bg-orange-50/50 text-orange-800 py-4 rounded-2xl font-bold italic text-sm">
             <div id="sheetEndProgress" class="absolute inset-0 bg-orange-200/30" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
             <span class="relative">é•¿æŒ‰æ­¤å¤„æå‰ç»“æŸ</span>
           </button>
        </div>
    </div>
  </div>

  <div id="goalSheet" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-md"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[85%] bg-white rounded-[2.5rem] p-8 text-center">
      <div class="text-5xl mb-4">ğŸ¯</div>
      <div class="text-2xl font-black text-gray-900 mb-6">è¾¾æˆ 7 æˆé¥±ï¼</div>
      <div class="space-y-4">
        <button id="continueBtn" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-black shadow-lg">ç»§ç»­ç”¨é¤</button>
        <button id="goalEndBtn" class="relative overflow-hidden w-full bg-gray-100 text-gray-900 py-5 rounded-2xl font-black">
           <div id="goalEndProgress" class="absolute inset-0 bg-gray-200" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
           <span class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
        </button>
      </div>
    </div>
  </div>

  <div id="bottomBar" class="hidden fixed left-0 right-0 bottom-0 z-30 bg-white/95 backdrop-blur border-t safe-bottom">
    <div class="px-5 py-4 flex justify-center">
      <button id="endBtn" class="relative overflow-hidden w-full max-w-sm bg-white border-2 border-gray-100 py-4 rounded-full font-black text-gray-400">
        <div id="endProgress" class="absolute inset-0 bg-orange-50" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
        <span id="endBtnLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
      </button>
    </div>
  </div>

  <script>
    /* ================= æ ¸å¿ƒé…ç½® ================= */
    const FIRST_CHECK_MS = 10000;  // 10ç§’æµ‹è¯•
    const NEXT_CHECK_MS  = 5000;   // 5ç§’æµ‹è¯•
    const REMINDER_EVERY_MS = 15000; 
    const LONG_PRESS_MS = 1000;

    let startTime = null, timerInterval = null, nextCheckTimeout = null, reminderInterval = null;
    let lastKeyForNext = "", lastChoiceLabel = "", isWaitingForChoice = false, hasStarted = false, hasEnded = false;
    let audioCtx = null, compressor = null, masterGain = null;

    const LABEL = { 
      "<5": "5æˆé¥±ä»¥ä¸‹", "5-6": "5ï¼6æˆ", "6-7": "6ï¼7æˆ", "7-goal": "7æˆï¼ˆè¾¾æˆç›®æ ‡ï¼‰", 
      "7-8": "7ï¼8æˆ", "8-9": "8ï¼9æˆ", "9-10": "9æˆï¼10æˆ", "10+": "10æˆè¿‡é‡", "11+": "è¶…çº§è¿‡é‡" 
    };

    /* ================= éŸ³æ•ˆå¼•æ“ ================= */
    function initAudio() {
      if (audioCtx) return;
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
      compressor = audioCtx.createDynamicsCompressor();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.7;
      compressor.connect(masterGain);
      masterGain.connect(audioCtx.destination);
    }

    function playTone(freq, start, dur, vol, type = "triangle") {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, start);
      g.gain.setValueAtTime(0.001, start);
      g.gain.exponentialRampToValueAtTime(vol, start + 0.05);
      g.gain.exponentialRampToValueAtTime(0.001, start + dur);
      o.connect(g); g.connect(compressor);
      o.start(start); o.stop(start + dur + 0.1);
    }

    function playCheckSound() {
      initAudio(); if (audioCtx.state === 'suspended') audioCtx.resume();
      const now = audioCtx.currentTime;
      playTone(523.25, now, 0.3, 0.4); // C5
      playTone(659.25, now + 0.15, 0.3, 0.4); // E5
    }

    function playSuccessMusic() {
      initAudio(); if (audioCtx.state === 'suspended') audioCtx.resume();
      const now = audioCtx.currentTime;
      // æ¬¢å¿«æ²»æ„ˆçš„æ—‹å¾‹: C5 - E5 - G5 - C6
      const seq = [523.25, 659.25, 783.99, 1046.50];
      seq.forEach((f, i) => {
        playTone(f, now + i * 0.15, 0.5, 0.3, "sine");
      });
    }

    /* ================= ä¸šåŠ¡é€»è¾‘ ================= */
    function startEating() {
      if (hasStarted) return;
      initAudio();
      hasStarted = true;
      startTime = new Date();
      
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('eatingScreen').classList.remove('hidden');
      document.getElementById('topHeader').classList.remove('hidden');
      document.getElementById('bottomBar').classList.remove('hidden'); // åƒé¥­æ—¶æ˜¾ç¤ºåº•éƒ¨
      
      timerInterval = setInterval(() => {
        const d = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('timerDisplay').textContent = 
          `${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
      }, 1000);

      nextCheckTimeout = setTimeout(triggerCheck, FIRST_CHECK_MS);
      playCheckSound();
      addLog(`å¼€å§‹ç”¨é¤ ğŸ¥¢`);
    }

    function triggerCheck() {
      if (!hasStarted || hasEnded || isWaitingForChoice) return;
      isWaitingForChoice = true;
      document.getElementById('choiceSheet').classList.remove('hidden');
      renderOptions();
      playCheckSound();
      reminderInterval = setInterval(() => { if(isWaitingForChoice) playCheckSound(); }, REMINDER_EVERY_MS);
    }

    function renderOptions() {
      const getOpts = (k) => {
        if (!k || k === "<5") return ["<5", "5-6", "6-7", "7-goal", "7-8"];
        if (k === "5-6") return ["5-6", "6-7", "7-goal", "7-8", "8-9"];
        if (["6-7", "7-goal"].includes(k)) return ["7-goal", "7-8", "8-9", "9-10", "10+"];
        return ["9-10", "10+", "11+"];
      };
      const container = document.getElementById('optionsContainer');
      container.innerHTML = '';
      getOpts(lastKeyForNext).forEach(key => {
        const btn = document.createElement('button');
        btn.className = "bg-white border-2 border-orange-100 py-4 rounded-2xl font-black text-gray-800 active:bg-orange-500 active:text-white transition-all";
        btn.textContent = LABEL[key];
        btn.onclick = () => selectOption(key);
        container.appendChild(btn);
      });
    }

    function selectOption(key) {
      lastKeyForNext = key; lastChoiceLabel = LABEL[key];
      isWaitingForChoice = false;
      document.getElementById('choiceSheet').classList.add('hidden');
      clearInterval(reminderInterval);
      
      const diff = Math.floor((Date.now() - startTime) / 1000);
      addLog(`${Math.floor(diff/60)}åˆ†${diff%60}ç§’ ï¼š${LABEL[key]}`);

      if (key === "7-goal") {
        document.getElementById('goalSheet').classList.remove('hidden');
        showBanner("å·²è¾¾æˆ 7 æˆç›®æ ‡ ğŸ¯", "è¿™æ˜¯æœ€èˆ’æœçš„è¿›é£ŸçŠ¶æ€ï¼Œå»ºè®®æ…¢æ…¢åœä¸‹ã€‚");
      } else if (key === "11+") {
        enterOverfull();
      } else {
        if (key === "6-7") showBanner("å¿«åˆ° 7 æˆé¥±äº†å“¦ï¼", "å¬å¬èº«ä½“çš„å£°éŸ³ï¼Œå°è¯•å‡æ…¢é€Ÿåº¦ï½");
        else if (["7-8", "8-9", "9-10", "10+"].includes(key)) {
            showBanner("å·²è¶…è¿‡é¢„å®šç›®æ ‡", "èƒƒéƒ¨å‹åŠ›æ­£åœ¨å¢å¤§ï¼Œå»ºè®®åŠæ—¶ç»“æŸç”¨é¤ã€‚");
            document.getElementById('sheetEndWrap').classList.remove('hidden');
            document.getElementById('endBtn').classList.add('text-orange-600', 'border-orange-200');
        }
        nextCheckTimeout = setTimeout(triggerCheck, NEXT_CHECK_MS);
      }
    }

    function enterOverfull() {
      hasEnded = true; clearInterval(timerInterval); clearTimeout(nextCheckTimeout);
      document.getElementById('eatingScreen').classList.add('hidden');
      document.getElementById('overfullScreen').classList.remove('hidden');
      document.getElementById('endBtnLabel').textContent = "é•¿æŒ‰ç»“æŸå¹¶è®°å½•";
      document.getElementById('endBtn').classList.add('text-orange-600', 'border-orange-200');
    }

    function showBanner(title, text) {
      document.getElementById('statusTitle').textContent = title;
      document.getElementById('statusText').textContent = text;
      document.getElementById('statusBanner').classList.remove('hidden');
    }

    function addLog(text) {
      const li = document.createElement('li');
      li.className = "border-l-4 border-orange-200 pl-3 py-1 fade-in-up text-xs";
      li.innerHTML = text;
      document.getElementById('logList').appendChild(li);
      document.getElementById('logEmpty').classList.add('hidden');
      document.getElementById('recordLog').scrollTop = document.getElementById('recordLog').scrollHeight;
    }

    function finalize() {
      if (hasEnded && !document.getElementById('endTransitionScreen').classList.contains('hidden')) return;
      hasEnded = true;
      clearInterval(timerInterval); clearTimeout(nextCheckTimeout); clearInterval(reminderInterval);

      // æ’­æ”¾æ€»ç»“éŸ³ä¹
      playSuccessMusic();

      ['eatingScreen', 'overfullScreen', 'goalSheet', 'choiceSheet', 'topHeader', 'bottomBar'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });

      document.getElementById('endTransitionScreen').classList.remove('hidden');
      document.getElementById('endTransitionText').textContent = `æœ€åè§‰å¯Ÿï¼š${lastChoiceLabel || 'è¿›è¡Œä¸­'}`;
      
      setTimeout(() => location.reload(), 5000);
    }

    /* ================= é•¿æŒ‰äº¤äº’ ================= */
    function bindLongPress(btn, progressEl, onComplete) {
      let t = null;
      const begin = (e) => { 
        e.preventDefault(); 
        let start = Date.now();
        if ('vibrate' in navigator) navigator.vibrate(20);
        t = setInterval(() => {
          const p = (Date.now() - start) / LONG_PRESS_MS;
          progressEl.style.transform = `scaleX(${Math.min(p, 1)})`;
          if (p >= 1) { clearInterval(t); onComplete(); }
        }, 20);
      };
      const stop = () => { clearInterval(t); progressEl.style.transform = 'scaleX(0)'; };
      btn.addEventListener('touchstart', begin); btn.addEventListener('touchend', stop);
      btn.addEventListener('mousedown', begin); btn.addEventListener('mouseup', stop);
    }

    document.getElementById('startBtn').onclick = startEating;
    document.getElementById('continueBtn').onclick = () => {
      document.getElementById('goalSheet').classList.add('hidden');
      nextCheckTimeout = setTimeout(triggerCheck, NEXT_CHECK_MS);
    };
    document.getElementById('toggleLogBtn').onclick = () => {
      const el = document.getElementById('recordLog');
      document.getElementById('toggleLogBtn').textContent = el.classList.toggle('hidden') ? 'å±•å¼€' : 'æŠ˜å ';
    };

    bindLongPress(document.getElementById('endBtn'), document.getElementById('endProgress'), finalize);
    bindLongPress(document.getElementById('goalEndBtn'), document.getElementById('goalEndProgress'), finalize);
    bindLongPress(document.getElementById('sheetEndBtn'), document.getElementById('sheetEndProgress'), finalize);
  </script>
</body>
</html>
