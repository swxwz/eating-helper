<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-select { -webkit-user-select:none; user-select:none; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

  <!-- é¡¶éƒ¨è®°å½•åŒºï¼ˆå¯æŠ˜å ï¼‰ -->
  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b">
    <div class="px-4 pt-3 pb-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ç”¨é¤è§‰å¯Ÿè®°å½•</div>
        <button id="toggleLogBtn"
          class="text-sm text-orange-600 font-medium btn-bounce px-3 py-2 rounded-lg active:bg-orange-50">
          æŠ˜å 
        </button>
      </div>

      <div id="recordLog" class="mt-2 max-h-32 overflow-y-auto text-sm text-gray-600">
        <ul id="logList" class="space-y-1"></ul>
        <div id="logEmpty" class="text-gray-400 py-2">è¿˜æ²¡æœ‰è®°å½•ã€‚å¼€å§‹åƒé¥­åä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡é€‰æ‹©ã€‚</div>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹ -->
  <main class="px-5 pt-6 pb-28">

    <!-- å¼€å§‹é¡µ -->
    <section id="startScreen" class="text-center space-y-5">
      <div class="text-6xl">ğŸ±</div>
      <div class="text-gray-800 font-semibold text-xl">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</div>
      <div class="text-gray-500 text-sm leading-relaxed">
        ä½ çš„ç›®æ ‡æ˜¯ <span class="font-semibold text-gray-800">7æˆé¥±</span>ã€‚<br />
        ç³»ç»Ÿä¼šå®šæ—¶ç”¨è½»æç¤ºéŸ³æé†’ä½ åšé€‰æ‹©ã€‚
      </div>

      <button id="startBtn"
        class="btn-bounce bg-orange-500 text-white w-full max-w-sm mx-auto px-10 py-4 rounded-full text-xl font-bold shadow-lg active:bg-orange-600">
        å¼€å§‹åƒé¥­
      </button>

      <div class="text-xs text-gray-400 leading-relaxed">
        æç¤ºï¼šä¸ºäº†å…¼å®¹è€å®‰å“ï¼Œæœ¬å·¥å…·ä½¿ç”¨â€œ1ç§’å†…è½»éŸ³ä¹æç¤ºéŸ³â€ä»£æ›¿è¯­éŸ³æé†’ã€‚
      </div>
    </section>

    <!-- åƒé¥­ä¸­ -->
    <section id="eatingScreen" class="hidden text-center space-y-4">
      <div class="relative w-44 h-44 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-6xl animate-bounce">ğŸ¥¢</div>
      </div>

      <div id="timerDisplay" class="text-gray-700 text-sm font-medium">å·²ç”¨æ—¶ï¼š00:00</div>

      <!-- çŠ¶æ€æé†’æ–‡æ¡ˆï¼ˆå¤§å­—ï¼‰ -->
      <div id="statusBanner" class="hidden mx-auto max-w-sm rounded-2xl border bg-white px-4 py-4 shadow-sm text-left">
        <div id="statusTitle" class="text-base font-extrabold text-gray-900"></div>
        <div id="statusText" class="mt-1 text-sm font-semibold text-gray-700 leading-relaxed"></div>
      </div>

      <div class="text-gray-400 text-xs leading-relaxed">
        åˆ°æ—¶é—´ä¼šå¼¹å‡ºé€‰æ‹©å¡ç‰‡ï¼ˆå¯æ»šåŠ¨ï¼‰ã€‚ä¸é€‰ä¼šè½»å£°é‡å¤æé†’ã€‚
      </div>
    </section>

    <!-- ç»ˆå±€ï¼šè¶…çº§è¿‡é‡ -->
    <section id="overfullScreen" class="hidden text-center space-y-6 pt-8">
      <div class="mx-auto w-28 h-28 rounded-full bg-orange-50 flex items-center justify-center shadow-inner">
        <svg width="64" height="64" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="#fb923c"/>
              <stop offset="1" stop-color="#f97316"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="28" fill="url(#g)" opacity="0.15"/>
          <path d="M32 10 L56 52 H8 Z" fill="url(#g)" opacity="0.95"/>
          <rect x="30.3" y="23" width="3.4" height="16" rx="1.7" fill="#fff"/>
          <circle cx="32" cy="44.5" r="2.2" fill="#fff"/>
        </svg>
      </div>

      <div class="text-3xl font-extrabold text-gray-900">è¶…çº§è¿‡é‡</div>
      <div class="text-gray-800 text-lg font-semibold leading-relaxed">
        ç°åœ¨å…ˆåœä¸‹æ¥ã€‚<br />
        æ·±å‘¼å¸ 3 æ¬¡ï¼Œå–ä¸€ç‚¹æ¸©æ°´ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚
      </div>
      <div class="text-gray-500 text-sm leading-relaxed">
        è®¡æ—¶ä¸æé†’å·²æš‚åœã€‚<br />
        åº•éƒ¨<strong>é•¿æŒ‰ 1 ç§’</strong>å³å¯ç»“æŸæœ¬æ¬¡è®°å½•ã€‚
      </div>
    </section>
  </main>

  <!-- é€‰æ‹©å¼¹å±‚ -->
  <div id="choiceSheet" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/30"></div>

    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl safe-bottom">
      <div class="px-5 pt-5 pb-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold text-gray-900">ä½ ç°åœ¨æœ‰å‡ æˆé¥±è…¹æ„Ÿï¼Ÿ</div>
            <div class="text-xs text-gray-400 mt-1">ä¸é€‰ä¼šè½»å£°é‡å¤æé†’</div>
          </div>
          <div class="text-xs text-gray-400 no-select" id="choiceHint"></div>
        </div>

        <div id="optionsContainer"
             class="mt-4 grid grid-cols-1 gap-3 overflow-y-auto"
             style="max-height: 52vh;">
        </div>

        <!-- è¶…è¿‡ç›®æ ‡åï¼šæ¯æ¬¡é€‰æ‹©é¢æ¿éƒ½å‡ºç°â€œç»“æŸç”¨é¤ï¼ˆé•¿æŒ‰ï¼‰â€æŒ‰é’® -->
        <div id="sheetEndWrap" class="hidden mt-4">
          <button id="sheetEndBtn"
            class="relative overflow-hidden w-full btn-bounce bg-white border-2 border-orange-200 text-orange-700 px-8 py-4 rounded-2xl text-base font-extrabold shadow-sm active:bg-orange-50">
            <div id="sheetEndProgress"
              class="absolute inset-0 bg-orange-100"
              style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;">
            </div>
            <span id="sheetEndLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸç”¨é¤</span>
          </button>
          <div class="text-xs text-gray-400 mt-2">
            å»ºè®®ï¼šå·²è¶…è¿‡ 7 æˆç›®æ ‡ï¼ŒåŠæ—¶ç»“æŸä¼šæ›´èˆ’æœã€‚
          </div>
        </div>

        <div class="h-2"></div>
      </div>
    </div>
  </div>

  <!-- ç›®æ ‡è¾¾æˆå¼¹å±‚ -->
  <div id="goalSheet" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/35"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl safe-bottom">
      <div class="px-5 pt-6 pb-5 text-center">
        <div class="text-2xl font-extrabold text-gray-900">ğŸ¯ è¾¾æˆç›®æ ‡ï¼š7æˆé¥±</div>
        <div class="mt-2 text-gray-700 text-base font-semibold leading-relaxed">
          å¤ªæ£’äº†ï¼ç°åœ¨åœåœ¨ 7 æˆä¼šæ›´èˆ’æœã€‚<br/>
          ä½ æƒ³ç»§ç»­ç”¨é¤è¿˜æ˜¯ç»“æŸï¼Ÿ
        </div>

        <div class="mt-5 grid grid-cols-1 gap-3">
          <button id="continueBtn"
            class="btn-bounce bg-orange-500 text-white py-4 rounded-2xl text-base font-extrabold shadow-md active:bg-orange-600">
            ç»§ç»­ç”¨é¤
          </button>

          <button id="goalEndBtn"
            class="relative overflow-hidden btn-bounce bg-white border-2 border-gray-200 text-gray-900 py-4 rounded-2xl text-base font-extrabold shadow-sm active:bg-gray-100">
            <div id="goalEndProgress"
              class="absolute inset-0 bg-gray-100"
              style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;">
            </div>
            <span id="goalEndLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸåƒé¥­</span>
          </button>
        </div>

        <div class="text-xs text-gray-400 mt-3">
          è®¡æ—¶ä»åœ¨ç»§ç»­ï¼Œä½ å¯ä»¥æ”¾å¿ƒå†³å®šã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œæ ï¼ˆé•¿æŒ‰ç»“æŸï¼‰ -->
  <div id="bottomBar" class="fixed left-0 right-0 bottom-0 z-30 bg-white/95 backdrop-blur border-t safe-bottom">
    <div class="px-4 py-3 flex items-center justify-center">
      <button id="endBtn"
        class="relative overflow-hidden btn-bounce w-full max-w-sm bg-white border-2 border-gray-200 text-gray-900 px-8 py-4 rounded-full text-lg font-semibold shadow-md active:bg-gray-100 disabled:opacity-40 disabled:active:bg-white">
        <div id="endProgress"
             class="absolute inset-0 bg-orange-100"
             style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;">
        </div>
        <span id="endBtnLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
      </button>
    </div>
  </div>

  <script>
    /* =========================================================
       âœ… ä½ åªéœ€è¦æ”¹è¿™é‡Œï¼ˆæé†’æ—¶é—´ + éŸ³é‡ï¼‰
       ========================================================= */
    const FIRST_CHECK_MS = 0 * 60 * 1000 + 5 * 1000; // 2åˆ†40ç§’ = 160000ms
    const NEXT_CHECK_MS  = 0 * 60 * 1000 + 5 * 1000; // 1åˆ†50ç§’ = 110000ms
    const REMINDER_EVERY_MS = 10 * 1000;
    const LONG_PRESS_MS = 1000;
    const CHIME_VOLUME = 0.34;

    const ENABLE_VIBRATE = true;
    const VIBRATE_PATTERN = [25];
    const ENABLE_CHIME = true;

    // ====== çŠ¶æ€ ======
    let startTime = null;
    let timerInterval = null;
    let nextCheckTimeout = null;
    let reminderInterval = null;

    let lastKeyForNext = "";
    let isWaitingForChoice = false;
    let hasStarted = false;
    let hasEnded = false;

    let goalAchieved = false;
    let overGoal = false;
    let superOverfull = false;

    // WebAudio
    let audioCtx = null;
    let audioUnlocked = false;

    // ====== DOM ======
    const startBtn = document.getElementById('startBtn');
    const startScreen = document.getElementById('startScreen');
    const eatingScreen = document.getElementById('eatingScreen');
    const overfullScreen = document.getElementById('overfullScreen');

    const timerDisplay = document.getElementById('timerDisplay');

    const statusBanner = document.getElementById('statusBanner');
    const statusTitle = document.getElementById('statusTitle');
    const statusText = document.getElementById('statusText');

    const choiceSheet = document.getElementById('choiceSheet');
    const choiceHint = document.getElementById('choiceHint');
    const optionsContainer = document.getElementById('optionsContainer');

    const sheetEndWrap = document.getElementById('sheetEndWrap');
    const sheetEndBtn = document.getElementById('sheetEndBtn');
    const sheetEndProgress = document.getElementById('sheetEndProgress');
    const sheetEndLabel = document.getElementById('sheetEndLabel');

    const goalSheet = document.getElementById('goalSheet');
    const continueBtn = document.getElementById('continueBtn');
    const goalEndBtn = document.getElementById('goalEndBtn');
    const goalEndProgress = document.getElementById('goalEndProgress');
    const goalEndLabel = document.getElementById('goalEndLabel');

    const logList = document.getElementById('logList');
    const logEmpty = document.getElementById('logEmpty');
    const recordLog = document.getElementById('recordLog');
    const toggleLogBtn = document.getElementById('toggleLogBtn');

    const endBtn = document.getElementById('endBtn');
    const endBtnLabel = document.getElementById('endBtnLabel');
    const endProgress = document.getElementById('endProgress');

    // ====== æ–‡æ¡ˆä¸é€‰é¡¹ ======
    const LABEL = {
      "<5":     "5æˆé¥±ä»¥ä¸‹",
      "5-6":    "5ï¼6æˆ",
      "6-7":    "6ï¼7æˆ",
      "7-goal": "7æˆï¼ˆè¾¾æˆç›®æ ‡ï¼‰",
      "7-8":    "7ï¼8æˆ",
      "8-9":    "8ï¼9æˆ",
      "8+":     "8æˆä»¥ä¸Š",
      "9+":     "9æˆä»¥ä¸Š",
      "9-10":   "9æˆï¼10æˆ",
      "10+":    "10æˆè¿‡é‡",
      "11+":    "è¶…çº§è¿‡é‡"
    };

    function nextOptionsByLast(k) {
      if (!k || k === "<5") return ["<5", "5-6", "6-7", "7-goal", "7-8"];
      if (k === "5-6")      return ["5-6", "6-7", "7-goal", "7-8", "8+"];
      if (k === "6-7")      return ["6-7", "7-goal", "7-8", "8-9", "9+"];
      if (k === "7-goal")   return ["7-goal", "7-8", "8-9", "9+"];
      if (k === "7-8")      return ["8-9", "9-10", "10+", "11+"]; // æ³¨æ„ï¼š9-10æœªåœ¨LABELé‡Œç”¨äºæŒ‰é’®ï¼Œè¿™é‡Œä¼šèµ°fallbackï¼ˆå¯åŠ ï¼‰
      if (k === "8-9")      return ["9-10", "10+", "11+"];
      if (k === "9+")       return ["9-10", "10+", "11+"];
      if (k === "9-10")     return ["9-10", "10+", "11+"];
      if (k === "10+")      return ["10+", "11+"];
      if (k === "11+")      return ["11+"];
      return ["9-10", "10+", "11+"];
    }

    // 9-10 æ–‡æ¡ˆè¡¥é½ï¼ˆé¿å…æŒ‰é’®æ˜¾ç¤º keyï¼‰
    LABEL["9-10"] = "9æˆï¼10æˆ";

    // ====== UIï¼šBanner ======
    function showBanner(title, text) {
      statusTitle.textContent = title;
      statusText.textContent = text;
      statusBanner.classList.remove('hidden');
    }
    function hideBanner() {
      statusBanner.classList.add('hidden');
      statusTitle.textContent = '';
      statusText.textContent = '';
    }

    // ====== åº•éƒ¨é•¿æŒ‰æŒ‰é’®â€œå±é™©æ€â€æ ·å¼åˆ‡æ¢ ======
    function setEndButtonDanger(isDanger) {
      // ä»…å½“æ­£åœ¨ç”¨é¤æ—¶æ‰è°ƒæ•´
      if (!hasStarted || hasEnded) return;

      if (isDanger) {
        endBtn.classList.remove('border-gray-200', 'text-gray-900', 'active:bg-gray-100', 'bg-white');
        endBtn.classList.add('border-orange-300', 'text-orange-800', 'active:bg-orange-50', 'bg-orange-50');
        endBtnLabel.textContent = superOverfull ? "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå·²æš‚åœï¼‰" : "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå»ºè®®ç°åœ¨ç»“æŸï¼‰";
        endProgress.classList.remove('bg-orange-100');
        endProgress.classList.add('bg-orange-200');
      } else {
        endBtn.classList.remove('border-orange-300', 'text-orange-800', 'active:bg-orange-50', 'bg-orange-50');
        endBtn.classList.add('border-gray-200', 'text-gray-900', 'active:bg-gray-100', 'bg-white');
        endBtnLabel.textContent = "é•¿æŒ‰ 1 ç§’ç»“æŸ";
        endProgress.classList.remove('bg-orange-200');
        endProgress.classList.add('bg-orange-100');
      }
    }

    // ====== è®¡æ—¶ ======
    function updateTimer() {
      if (!startTime) return;
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, '0');
      const s = String(diff % 60).padStart(2, '0');
      timerDisplay.textContent = `å·²ç”¨æ—¶ï¼š${m}:${s}`;
    }

    // ====== æ—¥å¿— ======
    function addLog(html) {
      logEmpty.classList.add('hidden');
      const li = document.createElement('li');
      li.className = "leading-relaxed";
      li.innerHTML = html;
      logList.appendChild(li);
      recordLog.scrollTop = recordLog.scrollHeight;
    }

    // ====== éœ‡åŠ¨ ======
    function softVibrate() {
      if (!ENABLE_VIBRATE) return;
      if (!('vibrate' in navigator)) return;
      try { navigator.vibrate(VIBRATE_PATTERN); } catch (_) {}
    }

    // ====== WebAudio ======
    async function unlockAudio() {
      if (!ENABLE_CHIME) return;
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        audioCtx = audioCtx || new AC();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        audioUnlocked = true;
      } catch (_) {}
    }

    function playChime() {
      if (!ENABLE_CHIME) return;
      if (!audioCtx || !audioUnlocked) return;

      try {
        const now = audioCtx.currentTime;
        const v1 = Math.min(CHIME_VOLUME, 0.35);
        const v2 = Math.min(CHIME_VOLUME * 1.25, 0.45);

        function tone(freq, start, dur, peak) {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(freq, start);

          g.gain.setValueAtTime(0.0001, start);
          g.gain.exponentialRampToValueAtTime(peak, start + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, start + dur);

          o.connect(g);
          g.connect(audioCtx.destination);
          o.start(start);
          o.stop(start + dur + 0.01);
        }

        tone(523.25, now + 0.00, 0.18, v1);
        tone(659.25, now + 0.22, 0.22, v2);
      } catch (_) {}
    }

    function notifyUser() {
      playChime();
      softVibrate();
    }

    // ====== è°ƒåº¦ ======
    function scheduleNextCheck(ms) {
      clearTimeout(nextCheckTimeout);
      nextCheckTimeout = setTimeout(triggerCheck, ms);
    }

    function openChoiceSheet() { choiceSheet.classList.remove('hidden'); }
    function closeChoiceSheet() { choiceSheet.classList.add('hidden'); }

    function openGoalSheet() { goalSheet.classList.remove('hidden'); }
    function closeGoalSheet() { goalSheet.classList.add('hidden'); }

    function renderOptions() {
      const options = nextOptionsByLast(lastKeyForNext);
      optionsContainer.innerHTML = '';
      choiceHint.textContent = options.length + ' ä¸ªé€‰é¡¹';

      options.forEach(key => {
        const btn = document.createElement('button');
        btn.className = "btn-bounce bg-white border-2 border-orange-200 py-3 rounded-xl shadow-sm active:bg-orange-50 transition text-base font-extrabold";
        btn.textContent = LABEL[key] || key;
        btn.addEventListener('click', () => makeChoice(key));
        optionsContainer.appendChild(btn);
      });

      if (overGoal && !superOverfull) sheetEndWrap.classList.remove('hidden');
      else sheetEndWrap.classList.add('hidden');
    }

    function triggerCheck() {
      if (!hasStarted || hasEnded) return;
      if (superOverfull) return;
      if (goalSheet && !goalSheet.classList.contains('hidden')) return;
      if (isWaitingForChoice) return;

      isWaitingForChoice = true;
      renderOptions();
      openChoiceSheet();

      clearInterval(reminderInterval);
      reminderInterval = setInterval(() => {
        if (isWaitingForChoice && !hasEnded) notifyUser();
      }, REMINDER_EVERY_MS);

      notifyUser();
    }

    function applyPostChoiceUX(key) {
      if (key === "6-7") {
        showBanner("å¿«åˆ° 7 æˆé¥±äº†å“¦ï¼", "å®å­ï¼Œåœåœ¨ 7 æˆä¼šè®©è‡ªå·±æ›´èˆ’æœï½");
        return;
      }
      if (key === "7-goal") {
        showBanner("å·²è¾¾æˆ 7 æˆç›®æ ‡ ğŸ¯", "ç°åœ¨åœä¸‹æ¥ä¼šæ›´èˆ’æœã€‚ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ç»§ç»­ã€‚");
        return;
      }

      const overKeys = new Set(["7-8", "8-9", "8+", "9+", "9-10", "10+"]);
      if (overKeys.has(key)) {
        showBanner("ä½ å·²ç»è¶…è¿‡ 7 æˆç›®æ ‡äº†", "æœªæ¥ä¸€æ®µæ—¶é—´è‚ èƒƒå¯èƒ½ä¼šå› ä¸ºæ’‘è€Œä¸èˆ’æœå“¦ï½å»ºè®®å°½å¿«ç»“æŸç”¨é¤ã€‚");
        return;
      }
      hideBanner();
    }

    function makeChoice(key) {
      const label = LABEL[key] || key;

      isWaitingForChoice = false;
      closeChoiceSheet();
      clearInterval(reminderInterval);

      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-orange-500 font-mono">${timeStr}</span> ï¼š${label}`);

      lastKeyForNext = key;

      if (key === "7-goal") {
        goalAchieved = true;
        applyPostChoiceUX(key);
        clearTimeout(nextCheckTimeout);
        openGoalSheet();
        return;
      }

      const overKeys = new Set(["7-8", "8-9", "8+", "9+", "9-10", "10+"]);
      if (overKeys.has(key)) {
        overGoal = true;
        applyPostChoiceUX(key);
        setEndButtonDanger(true); // âœ… è¶…è¿‡ç›®æ ‡ï¼šåº•éƒ¨æŒ‰é’®å˜é†’ç›®
        scheduleNextCheck(NEXT_CHECK_MS);
        return;
      }

      if (key === "11+") {
        enterOverfullState();
        return;
      }

      applyPostChoiceUX(key);
      scheduleNextCheck(NEXT_CHECK_MS);
    }

    function enterOverfullState() {
      superOverfull = true;
      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      isWaitingForChoice = false;
      closeChoiceSheet();
      closeGoalSheet();

      eatingScreen.classList.add('hidden');
      overfullScreen.classList.remove('hidden');

      setEndButtonDanger(true); // âœ… ç»ˆå±€ï¼šä¿æŒé†’ç›®
      endBtnLabel.textContent = "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå·²æš‚åœï¼‰";
    }

    // ====== ç»“æŸä¸é‡ç½® ======
    function setProgress(el, p) {
      const clamped = Math.max(0, Math.min(1, p));
      el.style.transform = `scaleX(${clamped})`;
    }

    function resetToStart() {
      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      startTime = null;
      timerInterval = null;
      nextCheckTimeout = null;
      reminderInterval = null;

      lastKeyForNext = "";
      isWaitingForChoice = false;
      hasStarted = false;
      hasEnded = false;

      goalAchieved = false;
      overGoal = false;
      superOverfull = false;

      closeChoiceSheet();
      closeGoalSheet();

      overfullScreen.classList.add('hidden');
      eatingScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');

      hideBanner();
      timerDisplay.textContent = "å·²ç”¨æ—¶ï¼š00:00";

      logList.innerHTML = "";
      logEmpty.classList.remove('hidden');
      recordLog.scrollTop = 0;

      endBtn.disabled = true;
      setEndButtonDanger(false); // âœ… å›å½’ä¸­æ€§æ ·å¼
      endBtnLabel.textContent = "é•¿æŒ‰ 1 ç§’ç»“æŸ";
      setProgress(endProgress, 0);
      setProgress(sheetEndProgress, 0);
      setProgress(goalEndProgress, 0);
      sheetEndWrap.classList.add('hidden');
    }

    function finalizeEndAndReset() {
      if (!hasStarted || hasEnded) return;
      hasEnded = true;

      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);
      closeChoiceSheet();
      closeGoalSheet();
      isWaitingForChoice = false;

      const diff = startTime ? Math.floor((Date.now() - startTime.getTime()) / 1000) : 0;
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-gray-400 font-mono">${timeStr}</span> ï¼šç»“æŸç”¨é¤ âœ…`);

      setTimeout(resetToStart, 150);
    }

    function bindLongPress({btn, progressEl, labelEl, idleText, holdingText, onComplete}) {
      let pressing = false;
      let t = null;

      function startPress() {
        if (btn.disabled) return;
        pressing = true;
        labelEl.textContent = holdingText;
        softVibrate();

        const start = Date.now();
        setProgress(progressEl, 0);

        t = setInterval(() => {
          const elapsed = Date.now() - start;
          const p = elapsed / LONG_PRESS_MS;
          setProgress(progressEl, p);
          if (elapsed >= LONG_PRESS_MS) {
            clearInterval(t);
            t = null;
            pressing = false;
            setProgress(progressEl, 1);
            onComplete();
          }
        }, 16);
      }

      function cancelPress() {
        if (!pressing) return;
        pressing = false;
        if (t) { clearInterval(t); t = null; }
        setProgress(progressEl, 0);
        labelEl.textContent = idleText;
      }

      btn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(); }, { passive: false });
      btn.addEventListener('touchend', cancelPress);
      btn.addEventListener('touchcancel', cancelPress);
      btn.addEventListener('mousedown', startPress);
      btn.addEventListener('mouseup', cancelPress);
      btn.addEventListener('mouseleave', cancelPress);
    }

    // ====== å¼€å§‹ ======
    async function startEating() {
      if (hasStarted) return;

      hasStarted = true;
      hasEnded = false;

      startTime = new Date();

      startScreen.classList.add('hidden');
      eatingScreen.classList.remove('hidden');
      overfullScreen.classList.add('hidden');

      setEndButtonDanger(false); // åˆå§‹ä¸­æ€§
      endBtn.disabled = false;

      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      await unlockAudio();
      try { playChime(); } catch (_) {}

      scheduleNextCheck(FIRST_CHECK_MS);
      addLog(`<span class="text-gray-400 font-mono">00åˆ†00ç§’</span> ï¼šå¼€å§‹ç”¨é¤`);
      hideBanner();
    }

    continueBtn.addEventListener('click', () => {
      closeGoalSheet();
      scheduleNextCheck(NEXT_CHECK_MS);
    });

    // ====== æŠ˜å è®°å½•åŒº ======
    let logCollapsed = false;
    toggleLogBtn.addEventListener('click', () => {
      logCollapsed = !logCollapsed;
      if (logCollapsed) {
        recordLog.classList.add('hidden');
        toggleLogBtn.textContent = 'å±•å¼€';
      } else {
        recordLog.classList.remove('hidden');
        toggleLogBtn.textContent = 'æŠ˜å ';
        recordLog.scrollTop = recordLog.scrollHeight;
      }
    });

    // ====== ç»‘å®šæŒ‰é’® ======
    startBtn.addEventListener('click', startEating);

    endBtn.disabled = true;
    bindLongPress({
      btn: endBtn,
      progressEl: endProgress,
      labelEl: endBtnLabel,
      idleText: "é•¿æŒ‰ 1 ç§’ç»“æŸ",
      holdingText: "ç»§ç»­æŒ‰ä½â€¦",
      onComplete: finalizeEndAndReset
    });

    bindLongPress({
      btn: sheetEndBtn,
      progressEl: sheetEndProgress,
      labelEl: sheetEndLabel,
      idleText: "é•¿æŒ‰ 1 ç§’ç»“æŸç”¨é¤",
      holdingText: "ç»§ç»­æŒ‰ä½â€¦",
      onComplete: finalizeEndAndReset
    });

    bindLongPress({
      btn: goalEndBtn,
      progressEl: goalEndProgress,
      labelEl: goalEndLabel,
      idleText: "é•¿æŒ‰ 1 ç§’ç»“æŸåƒé¥­",
      holdingText: "ç»§ç»­æŒ‰ä½â€¦",
      onComplete: finalizeEndAndReset
    });
  </script>
</body>
</html>
