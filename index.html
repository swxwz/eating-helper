<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-select { -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* è¾¾æ ‡åçš„é†’ç›®æ ·å¼ */
    .btn-danger-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.3); }
    
    select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
  </style>
</head>

<body class="bg-[#FFFAF2] min-h-screen font-sans no-select">

  <header id="topHeader" class="hidden sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-orange-50">
    <div class="px-4 pt-3 pb-3 flex items-center justify-between">
      <div class="text-xs font-bold text-gray-500 tracking-widest uppercase">Awareness Log</div>
      <button id="toggleLogBtn" class="text-xs text-orange-600 font-bold border border-orange-200 px-3 py-1 rounded-full">æŠ˜å </button>
    </div>
    <div id="recordLog" class="max-h-32 overflow-y-auto text-sm text-gray-600 px-4 pb-3">
      <ul id="logList" class="space-y-1 border-l-2 border-orange-100 ml-1"></ul>
    </div>
  </header>

  <main class="px-5 pt-6 pb-28">
    <section id="startScreen" class="text-center space-y-6 pt-10 fade-in">
      <div class="text-7xl">ğŸ²</div>
      <h1 class="text-2xl font-black text-gray-800 tracking-tight">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</h1>
      
      <div class="bg-white/70 rounded-[2rem] p-6 shadow-sm border border-orange-50 space-y-5 max-w-sm mx-auto text-left">
        <div>
          <label class="text-[10px] font-bold text-gray-400 mb-2 block uppercase ml-1">é¦–æ¬¡æé†’</label>
          <div class="flex gap-2">
            <select id="firstMin" class="flex-1 bg-white border border-gray-100 rounded-2xl px-3 py-3 text-sm font-bold text-gray-700"></select>
            <select id="firstSec" class="flex-1 bg-white border border-gray-100 rounded-2xl px-3 py-3 text-sm font-bold text-gray-700"></select>
          </div>
        </div>
        <div>
          <label class="text-[10px] font-bold text-gray-400 mb-2 block uppercase ml-1">åç»­é—´éš”</label>
          <div class="flex gap-2">
            <select id="nextMin" class="flex-1 bg-white border border-gray-100 rounded-2xl px-3 py-3 text-sm font-bold text-gray-700"></select>
            <select id="nextSec" class="flex-1 bg-white border border-gray-100 rounded-2xl px-3 py-3 text-sm font-bold text-gray-700"></select>
          </div>
        </div>
      </div>

      <button id="startBtn" class="btn-bounce bg-orange-500 text-white w-full max-w-xs h-16 mx-auto rounded-full text-lg font-black shadow-2xl shadow-orange-200 mt-4">
        å¼€å§‹ç”¨é¤
      </button>
    </section>

    <section id="eatingScreen" class="hidden text-center space-y-8 fade-in">
      <div id="timerDisplay" class="font-mono text-5xl font-thin text-orange-300 tracking-tighter">00:00</div>
      <div class="relative w-48 h-48 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-7xl animate-bounce duration-[3000ms]">ğŸ¥¢</div>
      </div>
      <div id="statusBanner" class="hidden mx-auto max-w-sm rounded-[2rem] border-2 border-orange-100 bg-white p-6 shadow-sm text-left">
        <div id="statusTitle" class="text-orange-600 font-black text-sm mb-1 italic"></div>
        <div id="statusText" class="text-gray-600 text-xs font-medium leading-relaxed"></div>
      </div>
    </section>

    <section id="overfullScreen" class="hidden text-center space-y-8 pt-10 fade-in">
      <div class="text-8xl">âš ï¸</div>
      <div class="text-3xl font-black text-gray-800 italic">è¶…çº§è¿‡é‡</div>
      <p class="text-gray-500 text-sm font-medium leading-relaxed px-6 italic">è¯·å¬ä»èº«ä½“çš„å‘¼å”¤ï¼Œç«‹å³ä¼‘æ¯ã€‚</p>
    </section>

    <section id="endTransitionScreen" class="hidden text-center pt-24 fade-in">
      <div class="space-y-10">
        <div class="text-2xl font-black text-gray-800">æ­å–œä½ ï¼Œåº¦è¿‡äº†äººç”Ÿä¸­çš„ä¸€é¤</div>
        
        <div class="py-6">
          <div class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.3em] mb-4">æœ¬æ¬¡è§‰å¯ŸçŠ¶æ€</div>
          <div id="endTransitionText" class="text-5xl font-black text-orange-500 tracking-tighter"></div>
        </div>

        <div class="text-2xl font-black text-gray-800 italic tracking-tight">
          æ„¿ä½ è¶Šæ¥è¶Šå¹¸ç¦~
        </div>

        <div class="pt-16 text-[10px] text-gray-300 font-bold uppercase tracking-widest">æ­£åœ¨æ¢å¤åˆå§‹çŠ¶æ€...</div>
      </div>
    </section>
  </main>

  <div id="choiceSheet" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-[3rem] shadow-2xl safe-bottom p-8">
        <div class="text-center mb-8">
          <div class="text-xl font-black text-gray-800">ä½ ç°åœ¨å‡ æˆé¥±äº†ï¼Ÿ</div>
        </div>
        <div id="optionsContainer" class="grid grid-cols-1 gap-3 max-h-[40vh] overflow-y-auto pr-1"></div>
        
        <div id="sheetEndWrap" class="hidden mt-6 pt-4 border-t border-gray-50 text-center">
           <button id="sheetEndBtn" class="relative overflow-hidden w-full bg-orange-500 text-white py-4 rounded-2xl font-black text-xs shadow-lg shadow-orange-100">
             <div id="sheetEndProgress" class="absolute inset-0 bg-orange-600/30" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
             <span class="relative tracking-widest">é•¿æŒ‰ç«‹å³ç»“æŸ</span>
           </button>
        </div>
    </div>
  </div>

  <div id="goalSheet" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-md"></div>
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[88%] bg-white rounded-[3rem] p-10 text-center shadow-2xl">
      <div class="text-5xl mb-6">ğŸ¯</div>
      <div class="text-2xl font-black text-gray-800 mb-2 font-mono">è¾¾æˆ 7 æˆé¥±ï¼</div>
      <p class="text-gray-400 text-xs font-bold mb-10">å»ºè®®åœ¨æ­¤åˆ»åœä¸‹ï¼Œäº«å—èº«ä½“çš„è½»ç›ˆã€‚</p>
      <div class="space-y-4">
        <button id="continueBtn" class="w-full bg-white border-2 border-gray-100 text-gray-400 py-5 rounded-3xl font-black">ç»§ç»­ç”¨é¤</button>
        <button id="goalEndBtn" class="relative overflow-hidden w-full bg-orange-500 text-white py-5 rounded-3xl font-black shadow-xl shadow-orange-100">
           <div id="goalEndProgress" class="absolute inset-0 bg-orange-600/30" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
           <span class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
        </button>
      </div>
    </div>
  </div>

  <div id="bottomBar" class="hidden fixed left-0 right-0 bottom-0 z-30 bg-white/80 backdrop-blur-md safe-bottom border-t border-gray-50">
    <div class="px-5 py-4 flex justify-center">
      <button id="endBtn" class="relative overflow-hidden w-full max-w-xs bg-white border border-gray-300 py-4 rounded-full font-black text-gray-500 transition-colors duration-300">
        <div id="endProgress" class="absolute inset-0 bg-orange-100/50" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
        <span id="endBtnLabel" class="relative tracking-widest">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
      </button>
    </div>
  </div>

  <script>
    /* ================= æ ¸å¿ƒé…ç½® ================= */
    const MS_PER_MIN = 60000;
    const MS_PER_SEC = 1000;
    const STORAGE_KEY_V6 = 'eating_v6_config';

    let configFirst = 160000;
    let configNext = 110000;
    let wakeLock = null;

    let startTime = null, timerInterval = null, nextCheckTimeout = null, reminderInterval = null;
    let lastKeyForNext = "", lastChoiceLabel = "", isWaitingForChoice = false, hasStarted = false, hasEnded = false;
    let audioCtx = null, compressor = null, masterGain = null;

    const LABEL = { "<5": "5æˆé¥±ä»¥ä¸‹", "5-6": "5ï¼6æˆ", "6-7": "6ï¼7æˆ", "7-goal": "7æˆé¥± (è¾¾æ ‡)", "7-8": "7ï¼8æˆ", "8-9": "8ï¼9æˆ", "9-10": "9-10æˆ", "10+": "10æˆè¿‡é‡", "11+": "è¶…çº§è¿‡é‡" };

    /* ================= å±å¹•å¸¸äº® ================= */
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
        }
      } catch (err) {
        console.error(`${err.name}, ${err.message}`);
      }
    }

    function releaseWakeLock() {
      if (wakeLock !== null) {
        wakeLock.release();
        wakeLock = null;
      }
    }

    /* ================= åˆå§‹åŒ–é…ç½® ================= */
    function populateSelects() {
      const fMin = document.getElementById('firstMin'), fSec = document.getElementById('firstSec');
      const nMin = document.getElementById('nextMin'), nSec = document.getElementById('nextSec');
      for(let i=0; i<=10; i++) fMin.add(new Option(i + ' åˆ†', i));
      for(let i=0; i<=5; i++) nMin.add(new Option(i + ' åˆ†', i));
      for(let i=0; i<60; i+=10) { fSec.add(new Option(i + ' ç§’', i)); nSec.add(new Option(i + ' ç§’', i)); }
      
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY_V6) || '{}');
      configFirst = saved.first || 160000;
      configNext = saved.next || 110000;

      fMin.value = Math.floor(configFirst / MS_PER_MIN); fSec.value = (configFirst % MS_PER_MIN) / MS_PER_SEC;
      nMin.value = Math.floor(configNext / MS_PER_MIN); nSec.value = (configNext % MS_PER_MIN) / MS_PER_SEC;

      const save = () => {
        configFirst = (fMin.value * MS_PER_MIN) + (fSec.value * MS_PER_SEC) || 10000;
        configNext = (nMin.value * MS_PER_MIN) + (nSec.value * MS_PER_SEC) || 5000;
        localStorage.setItem(STORAGE_KEY_V6, JSON.stringify({first: configFirst, next: configNext}));
      };
      [fMin, fSec, nMin, nSec].forEach(el => el.onchange = save);
    }
    populateSelects();

    /* ================= éŸ³æ•ˆå¼•æ“ ================= */
    function initAudio() {
      if (audioCtx) return;
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC(); compressor = audioCtx.createDynamicsCompressor();
      masterGain = audioCtx.createGain(); masterGain.gain.value = 1.0;
      compressor.connect(masterGain); masterGain.connect(audioCtx.destination);
    }
    function playTone(f, s, d, v, t = "triangle") {
      try {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, s);
        g.gain.setValueAtTime(0.001, s); g.gain.exponentialRampToValueAtTime(v, s + 0.05);
        g.gain.exponentialRampToValueAtTime(0.001, s + d);
        o.connect(g); g.connect(compressor); o.start(s); o.stop(s + d + 0.1);
      } catch(e){}
    }
    function playCheckSound() {
      initAudio(); if (audioCtx.state === 'suspended') audioCtx.resume();
      const n = audioCtx.currentTime; playTone(523.25, n, 0.3, 0.6); playTone(659.25, n + 0.15, 0.3, 0.6);
    }
    function playSuccessMusic() {
      initAudio(); if (audioCtx.state === 'suspended') audioCtx.resume();
      const n = audioCtx.currentTime; [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => playTone(f, n + i * 0.15, 0.6, 0.5, "sine"));
    }

    /* ================= æ ¸å¿ƒæµç¨‹ ================= */
    function startEating() {
      if (hasStarted) return;
      initAudio(); requestWakeLock(); 
      hasStarted = true; startTime = new Date();
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('eatingScreen').classList.remove('hidden');
      document.getElementById('topHeader').classList.remove('hidden');
      document.getElementById('bottomBar').classList.remove('hidden');
      timerInterval = setInterval(() => {
        const d = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('timerDisplay').textContent = `${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
      }, 1000);
      nextCheckTimeout = setTimeout(triggerCheck, configFirst);
      playCheckSound(); addLog(`ç”¨é¤è§‰å¯Ÿå¼€å¯`);
    }

    function triggerCheck() {
      if (!hasStarted || hasEnded || isWaitingForChoice) return;
      isWaitingForChoice = true;
      document.getElementById('choiceSheet').classList.remove('hidden');
      renderOptions(); playCheckSound();
      clearInterval(reminderInterval);
      reminderInterval = setInterval(() => { if(isWaitingForChoice) playCheckSound(); }, 15000);
    }

    function renderOptions() {
      const getOpts = (k) => {
        if (!k || k === "<5") return ["<5", "5-6", "6-7", "7-goal", "7-8"];
        if (k === "5-6") return ["5-6", "6-7", "7-goal", "7-8", "8-9"];
        return ["7-goal", "7-8", "8-9", "9-10", "10+", "11+"];
      };
      const container = document.getElementById('optionsContainer'); container.innerHTML = '';
      getOpts(lastKeyForNext).forEach(key => {
        const btn = document.createElement('button');
        btn.className = "bg-white border border-gray-100 py-4 rounded-2xl font-black text-gray-600 active:bg-orange-500 active:text-white transition-all";
        btn.textContent = LABEL[key]; btn.onclick = () => selectOption(key); container.appendChild(btn);
      });
    }

    function selectOption(key) {
      lastKeyForNext = key; lastChoiceLabel = LABEL[key]; isWaitingForChoice = false;
      document.getElementById('choiceSheet').classList.add('hidden'); clearInterval(reminderInterval);
      const diff = Math.floor((Date.now() - startTime) / 1000);
      addLog(`${Math.floor(diff/60)}åˆ†${diff%60}ç§’ ï¼š${LABEL[key]}`);

      // é†’ç›®æç¤ºé€»è¾‘
      if (["7-goal", "7-8", "8-9", "9-10", "10+", "11+"].includes(key)) {
        document.getElementById('endBtn').classList.add('btn-danger-active');
        document.getElementById('endBtnLabel').textContent = "å»ºè®®ç°åœ¨ç»“æŸç”¨é¤";
      }

      if (key === "7-goal") {
        document.getElementById('goalSheet').classList.remove('hidden');
        showBanner("å·²è¾¾æˆ 7 æˆé¥± ğŸ¯", "ç»†ç»†æ„Ÿå—æ­¤åˆ»çš„è½»ç›ˆã€‚");
      } else if (key === "11+") {
        hasEnded = true; clearInterval(timerInterval); clearTimeout(nextCheckTimeout);
        document.getElementById('eatingScreen').classList.add('hidden'); document.getElementById('overfullScreen').classList.remove('hidden');
      } else {
        if (key === "6-7") showBanner("å¿«åˆ° 7 æˆé¥±äº†å“¦ï¼", "æ”¾æ…¢èŠ‚å¥ï¼Œè†å¬èº«ä½“çš„å›åº”ã€‚");
        else if (["7-8", "8-9", "9-10", "10+"].includes(key)) {
            showBanner("å·²è¶…è¿‡é¢„å®šç›®æ ‡", "å»ºè®®æ…¢æ…¢æ”¾ä¸‹ç­·å­ã€‚");
            document.getElementById('sheetEndWrap').classList.remove('hidden');
        }
        clearTimeout(nextCheckTimeout); nextCheckTimeout = setTimeout(triggerCheck, configNext);
      }
    }

    function showBanner(title, text) {
      document.getElementById('statusTitle').textContent = title;
      document.getElementById('statusText').textContent = text;
      document.getElementById('statusBanner').classList.remove('hidden');
    }

    function addLog(text) {
      const li = document.createElement('li'); li.className = "pl-2 py-1 text-[10px] font-bold text-gray-400 mb-1";
      li.innerHTML = text; document.getElementById('logList').appendChild(li);
      document.getElementById('recordLog').scrollTop = document.getElementById('recordLog').scrollHeight;
    }

    function finalize() {
      if (hasEnded && !document.getElementById('endTransitionScreen').classList.contains('hidden')) return;
      hasEnded = true; releaseWakeLock();
      clearInterval(timerInterval); clearTimeout(nextCheckTimeout); clearInterval(reminderInterval);
      playSuccessMusic();
      ['eatingScreen', 'overfullScreen', 'goalSheet', 'choiceSheet', 'topHeader', 'bottomBar'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('endTransitionScreen').classList.remove('hidden');
      document.getElementById('endTransitionText').textContent = `${lastChoiceLabel || 'è¿›è¡Œä¸­'}`;
      setTimeout(() => {
        location.reload(); // é‡ç½®ä»¥ç¡®ä¿æ‰€æœ‰çŠ¶æ€æ¸…é›¶
      }, 5000);
    }

    function bindLP(btn, progressEl, onComplete) {
      let t = null;
      const begin = (e) => { 
        e.preventDefault(); let s = Date.now(); if('vibrate' in navigator) navigator.vibrate(20);
        t = setInterval(() => { const p = (Date.now() - s) / 1000; progressEl.style.transform = `scaleX(${Math.min(p, 1)})`; if(p >= 1) { clearInterval(t); onComplete(); } }, 20); };
      const stop = () => { clearInterval(t); progressEl.style.transform = 'scaleX(0)'; };
      btn.addEventListener('touchstart', begin); btn.addEventListener('touchend', stop);
      btn.addEventListener('mousedown', begin); btn.addEventListener('mouseup', stop);
    }

    document.getElementById('startBtn').onclick = startEating;
    document.getElementById('continueBtn').onclick = () => { document.getElementById('goalSheet').classList.add('hidden'); nextCheckTimeout = setTimeout(triggerCheck, configNext); };
    document.getElementById('toggleLogBtn').onclick = () => { const el = document.getElementById('recordLog'); document.getElementById('toggleLogBtn').textContent = el.classList.toggle('hidden') ? 'å±•å¼€' : 'æŠ˜å '; };
    bindLP(document.getElementById('endBtn'), document.getElementById('endProgress'), finalize);
    bindLP(document.getElementById('goalEndBtn'), document.getElementById('goalEndProgress'), finalize);
    bindLP(document.getElementById('sheetEndBtn'), document.getElementById('sheetEndProgress'), finalize);
  </script>
</body>
</html>
