<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

  <!-- é¡¶éƒ¨è®°å½•åŒºï¼ˆå¯æŠ˜å ï¼‰ -->
  <header class="sticky top-0 z-20 bg-white/95 backdrop-blur border-b">
    <div class="px-4 pt-4 pb-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ç”¨é¤è§‰å¯Ÿè®°å½•</div>
        <button id="toggleLogBtn"
          class="text-sm text-orange-600 font-medium btn-bounce px-3 py-2 rounded-lg active:bg-orange-50">
          æŠ˜å 
        </button>
      </div>

      <div id="recordLog" class="mt-2 max-h-40 overflow-y-auto text-sm text-gray-600">
        <ul id="logList" class="space-y-1"></ul>
        <div id="logEmpty" class="text-gray-400 py-2">è¿˜æ²¡æœ‰è®°å½•ã€‚å¼€å§‹åƒé¥­åä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡é€‰æ‹©ã€‚</div>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹ -->
  <main class="px-5 pt-8 pb-28">
    <!-- å¼€å§‹é¡µ -->
    <section id="startScreen" class="text-center space-y-6">
      <div class="text-6xl">ğŸ±</div>
      <div class="text-gray-700 font-semibold text-xl">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</div>
      <div class="text-gray-400 text-sm leading-relaxed">
        å¼€å§‹åƒé¥­åï¼Œç³»ç»Ÿä¼šå®šæ—¶è½»å£°æé†’ä½ é€‰æ‹©é¥±è…¹æ„Ÿã€‚<br />
        è®°å½•ä¼šæ˜¾ç¤ºåœ¨ä¸Šæ–¹ã€‚
      </div>

      <button onclick="startEating()"
        class="btn-bounce bg-orange-500 text-white w-full max-w-sm mx-auto px-10 py-4 rounded-full text-xl font-bold shadow-lg active:bg-orange-600">
        å¼€å§‹åƒé¥­
      </button>

      <div class="text-xs text-gray-400">
        å°æç¤ºï¼šæ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦ä½ ç‚¹å‡»ä¸€æ¬¡åæ‰èƒ½æ’­æ”¾è¯­éŸ³æé†’ã€‚
      </div>
    </section>

    <!-- åƒé¥­ä¸­ -->
    <section id="eatingScreen" class="hidden text-center space-y-6">
      <div class="relative w-52 h-52 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-6xl animate-bounce">ğŸ¥¢</div>
      </div>

      <div id="timerDisplay" class="text-gray-500 text-sm">å·²ç”¨æ—¶ï¼š00:00</div>

      <!-- æé—®åŒº -->
      <div id="questionBox" class="hidden space-y-4">
        <p class="text-lg font-semibold text-gray-800">ä½ ç°åœ¨æœ‰å‡ æˆé¥±è…¹æ„Ÿï¼Ÿ</p>
        <div id="optionsContainer" class="grid grid-cols-1 gap-3"></div>

        <div class="text-xs text-gray-400 leading-relaxed">
          å¦‚æœä½ æš‚æ—¶ä¸æƒ³é€‰ï¼Œä¼šæ¯éš”ä¸€æ®µæ—¶é—´è½»å£°æé†’ä¸€æ¬¡ã€‚
        </div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œæ  -->
  <div class="fixed left-0 right-0 bottom-0 z-30 bg-white/95 backdrop-blur border-t safe-bottom">
    <div class="px-4 py-3 flex items-center justify-center gap-3">
      <button id="endBtn" onclick="stopEating()"
        class="btn-bounce w-full max-w-sm bg-white border-2 border-gray-200 text-gray-800 px-10 py-4 rounded-full text-lg font-semibold shadow-md active:bg-gray-100 disabled:opacity-40 disabled:active:bg-white">
        ç»“æŸåƒé¥­
      </button>
    </div>
  </div>

  <script>
    /* =========================================================
       âœ… è¿™é‡Œæ”¹æ—¶é—´ï¼šç¬¬ä¸€è½®æé†’ / åç»­æ¯è½®æé†’
       ========================================================= */
    const FIRST_CHECK_MS = 10 * 1000; // ç¬¬ä¸€è½®ï¼š10ç§’ï¼ˆä½ è¦æ”¹å°±æ”¹è¿™é‡Œï¼‰
    const NEXT_CHECK_MS  = 5  * 1000; // åç»­æ¯è½®ï¼š5ç§’ï¼ˆä½ è¦æ”¹å°±æ”¹è¿™é‡Œï¼‰

    /* =========================================================
       âœ… è¿™é‡Œæ”¹â€œæœªé€‰æ‹©æŒç»­æé†’â€çš„é¢‘ç‡
       ========================================================= */
    const REMINDER_EVERY_MS = 10 * 1000; // ä¸é€‰æ‹©æ—¶ï¼Œæ¯10ç§’æé†’ä¸€æ¬¡

    /* =========================================================
       âœ… å¯é€‰ï¼šæ˜¯å¦éœ‡åŠ¨ï¼ˆæ‰‹æœºæ”¯æŒæ‰ä¼šç”Ÿæ•ˆï¼‰
       ========================================================= */
    const ENABLE_VIBRATE = true;
    const VIBRATE_PATTERN = [30]; // å¾ˆè½»çš„éœ‡åŠ¨

    let startTime;
    let timerInterval;
    let nextCheckTimeout;
    let reminderInterval;

    let lastKeyForNext = ""; // ç”¨â€œé”®â€é©±åŠ¨ä¸‹ä¸€è½®é€‰é¡¹
    let isWaitingForChoice = false;
    let hasStarted = false;

    const logList = document.getElementById('logList');
    const logEmpty = document.getElementById('logEmpty');
    const recordLog = document.getElementById('recordLog');
    const toggleLogBtn = document.getElementById('toggleLogBtn');

    const questionBox = document.getElementById('questionBox');
    const optionsContainer = document.getElementById('optionsContainer');

    const endBtn = document.getElementById('endBtn');

    // ====== é€‰é¡¹é…ç½®ï¼ˆç”¨ keyï¼Œé¿å…ä¸­æ–‡å­—ç¬¦ä¸²åŒ¹é…æ¼æ‰ï¼‰======
    const LABEL = {
      "<5":  "5æˆé¥±ä»¥ä¸‹",
      "5-6": "5ï¼6æˆ",
      "6-7": "6ï¼7æˆ",
      "7+":  "7æˆä»¥ä¸Š",
      "7-8": "7ï¼8æˆ",
      "8-9": "8ï¼9æˆ",
      "8+":  "8æˆä»¥ä¸Š",
      "9+":  "9æˆä»¥ä¸Š",
      "9-10":"9æˆï¼10æˆ",
      "10+": "10æˆè¿‡é‡",
      "11+": "è¶…çº§è¿‡é‡"
    };

    function normalizeForNext(key) {
      if (key === "7+") return "7-8";
      if (key === "8+") return "8-9";
      if (key === "9+") return "9-10";
      return key;
    }

    function nextOptionsByLast(lastNormalizedKey) {
      if (!lastNormalizedKey || lastNormalizedKey === "<5") return ["<5", "5-6", "6-7", "7+"];

      if (lastNormalizedKey === "5-6") return ["5-6", "6-7", "7-8", "8+"];
      if (lastNormalizedKey === "6-7") return ["6-7", "7-8", "8-9", "9+"];

      if (lastNormalizedKey === "7-8") return ["8-9", "9-10", "10+", "11+"];

      // ä½ æ²¡æ˜ç¡® 8-9 çš„è§„åˆ™ï¼Œè¿™é‡Œåšè‡ªç„¶è¡”æ¥
      if (lastNormalizedKey === "8-9") return ["9-10", "10+", "11+"];

      if (lastNormalizedKey === "9-10") return ["9-10", "10+", "11+"];
      if (lastNormalizedKey === "10+") return ["10+", "11+"];
      if (lastNormalizedKey === "11+") return ["11+"];

      return ["9-10", "10+", "11+"];
    }

    // ====== æŸ”å’Œè¯­éŸ³æé†’ï¼ˆé˜²æ’é˜Ÿï¼‰======
    function playSoftNotice() {
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance("è¯·é—®ä½ ç°åœ¨å‡ æˆé¥±äº†ï¼Ÿ");
      msg.rate = 0.85;
      msg.pitch = 1.0;
      msg.lang = 'zh-CN';
      window.speechSynthesis.speak(msg);
    }

    function softVibrate() {
      if (!ENABLE_VIBRATE) return;
      if (!('vibrate' in navigator)) return;
      try { navigator.vibrate(VIBRATE_PATTERN); } catch (_) {}
    }

    function scheduleNextCheck(ms) {
      clearTimeout(nextCheckTimeout);
      nextCheckTimeout = setTimeout(triggerCheck, ms);
    }

    function updateTimer() {
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, '0');
      const s = String(diff % 60).padStart(2, '0');
      document.getElementById('timerDisplay').innerText = `å·²ç”¨æ—¶ï¼š${m}:${s}`;
    }

    function scrollLogToTopNew() {
      // ä½ ç”¨çš„æ˜¯ prependï¼Œæ–°è®°å½•åœ¨é¡¶éƒ¨ï¼Œä¿æŒé¡¶éƒ¨å³å¯
      recordLog.scrollTop = 0;
    }

    function renderOptions() {
      const options = nextOptionsByLast(lastKeyForNext);
      optionsContainer.innerHTML = '';
      options.forEach(key => {
        const btn = document.createElement('button');
        btn.className = "btn-bounce bg-white border-2 border-orange-200 py-3 rounded-xl shadow-sm active:bg-orange-50 transition text-base font-semibold";
        btn.innerText = LABEL[key] || key;
        btn.onclick = () => makeChoice(key);
        optionsContainer.appendChild(btn);
      });
    }

    function triggerCheck() {
      if (!hasStarted) return;
      if (isWaitingForChoice) return;

      isWaitingForChoice = true;
      questionBox.classList.remove('hidden');
      renderOptions();

      clearInterval(reminderInterval);
      reminderInterval = setInterval(() => {
        if (isWaitingForChoice) {
          playSoftNotice();
          softVibrate();
        }
      }, REMINDER_EVERY_MS);

      playSoftNotice();
      softVibrate();
    }

    function addLog(labelText) {
      logEmpty.classList.add('hidden');
      const li = document.createElement('li');
      li.className = "leading-relaxed";
      li.innerHTML = labelText;
      logList.prepend(li);
      scrollLogToTopNew();
    }

    function makeChoice(key) {
      const label = LABEL[key] || key;

      isWaitingForChoice = false;
      questionBox.classList.add('hidden');
      clearInterval(reminderInterval);

      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;

      addLog(`<span class="text-orange-500 font-mono">${timeStr}</span> ï¼š${label}`);

      lastKeyForNext = normalizeForNext(key);

      if (lastKeyForNext === "11+") {
        alert("æ£€æµ‹åˆ°å·²è¾¾åˆ°è¶…çº§è¿‡é‡ï¼Œå»ºè®®åœæ­¢è¿›é£Ÿå“¦ã€‚");
        // å¦‚æœä½ æƒ³â€œæœ€ç»ˆé€‰æ‹©åä¸å†æé†’â€ï¼ŒæŠŠä¸‹é¢è¿™ä¸€è¡Œå–æ¶ˆæ³¨é‡Šå³å¯ï¼š
        // return;
      }

      scheduleNextCheck(NEXT_CHECK_MS);
    }

    // ========= å…¥å£ =========
    function startEating() {
      hasStarted = true;
      startTime = new Date();

      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('eatingScreen').classList.remove('hidden');

      endBtn.disabled = false;

      // è§£é”éŸ³é¢‘ï¼ˆæœ‰äº›æµè§ˆå™¨éœ€è¦ç¬¬ä¸€æ¬¡ç‚¹å‡»åæ‰å…è®¸ speakï¼‰
      playSoftNotice();
      window.speechSynthesis.cancel();

      timerInterval = setInterval(updateTimer, 1000);

      // ç¬¬ä¸€è½®ï¼š10ç§’
      scheduleNextCheck(FIRST_CHECK_MS);
    }

    function stopEating() {
      if (!hasStarted) {
        alert("è¿˜æ²¡å¼€å§‹åƒé¥­å“¦ï½");
        return;
      }
      if (!confirm("ç¡®å®šç»“æŸç”¨é¤å—ï¼Ÿ")) return;

      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      // ç»“æŸæ—¶å†åŠ ä¸€æ¡è®°å½•
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-gray-400 font-mono">${timeStr}</span> ï¼šç»“æŸç”¨é¤ âœ…`);

      // ç®€å•é‡ç½®ï¼ˆä¹Ÿå¯ä»¥æ”¹æˆå±•ç¤ºæ€»ç»“é¡µï¼‰
      setTimeout(() => location.reload(), 600);
    }

    // ========= è®°å½•åŒºæŠ˜å  =========
    let logCollapsed = false;
    toggleLogBtn.addEventListener('click', () => {
      logCollapsed = !logCollapsed;
      if (logCollapsed) {
        recordLog.classList.add('hidden');
        toggleLogBtn.innerText = 'å±•å¼€';
      } else {
        recordLog.classList.remove('hidden');
        toggleLogBtn.innerText = 'æŠ˜å ';
      }
    });

    // åˆå§‹åŒ–ï¼šç»“æŸæŒ‰é’®é»˜è®¤å¯ç”¨/ä¸å¯ç”¨ä½ è‡ªå·±å†³å®š
    endBtn.disabled = true;
  </script>
</body>
</html>

