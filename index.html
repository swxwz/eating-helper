<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-select { -webkit-user-select:none; user-select:none; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

  <!-- é¡¶éƒ¨è®°å½•åŒºï¼ˆå¯æŠ˜å ï¼‰ -->
  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b">
    <div class="px-4 pt-3 pb-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ç”¨é¤è§‰å¯Ÿè®°å½•</div>
        <button id="toggleLogBtn"
          class="text-sm text-orange-600 font-medium btn-bounce px-3 py-2 rounded-lg active:bg-orange-50">
          æŠ˜å 
        </button>
      </div>

      <div id="recordLog" class="mt-2 max-h-32 overflow-y-auto text-sm text-gray-600">
        <ul id="logList" class="space-y-1"></ul>
        <div id="logEmpty" class="text-gray-400 py-2">è¿˜æ²¡æœ‰è®°å½•ã€‚å¼€å§‹åƒé¥­åä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡é€‰æ‹©ã€‚</div>
      </div>

      <!-- æ‰‹æœºä¸Šçš„é”™è¯¯/çŠ¶æ€æç¤ºï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ -->
      <div id="debugBar" class="mt-2 text-xs text-gray-400 hidden"></div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹ -->
  <main class="px-5 pt-6 pb-28">
    <!-- å¼€å§‹é¡µ -->
    <section id="startScreen" class="text-center space-y-5">
      <div class="text-6xl">ğŸ±</div>
      <div class="text-gray-800 font-semibold text-xl">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</div>
      <div class="text-gray-500 text-sm leading-relaxed">
        åƒåˆ°åˆé€‚çš„é¥±å°±åœä¸‹ã€‚<br />
        ç³»ç»Ÿä¼šå®šæ—¶è½»å£°æé†’ä½ åšé€‰æ‹©ã€‚
      </div>

      <button id="startBtn"
        class="btn-bounce bg-orange-500 text-white w-full max-w-sm mx-auto px-10 py-4 rounded-full text-xl font-bold shadow-lg active:bg-orange-600">
        å¼€å§‹åƒé¥­
      </button>

      <div class="text-xs text-gray-400 leading-relaxed">
        æç¤ºï¼šéƒ¨åˆ†å®‰å“æµè§ˆå™¨è¯­éŸ³ä¸ç¨³å®šï¼Œä½†ä¸ä¼šå½±å“è®¡æ—¶ä¸æµç¨‹ï¼ˆä¼šè‡ªåŠ¨é™çº§ä¸ºè½»æç¤ºéŸ³/éœ‡åŠ¨ï¼‰ã€‚
      </div>
    </section>

    <!-- åƒé¥­ä¸­ -->
    <section id="eatingScreen" class="hidden text-center space-y-4">
      <div class="relative w-44 h-44 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-6xl animate-bounce">ğŸ¥¢</div>
      </div>

      <div id="timerDisplay" class="text-gray-600 text-sm">å·²ç”¨æ—¶ï¼š00:00</div>

      <div class="text-gray-400 text-xs leading-relaxed">
        åˆ°æ—¶é—´ä¼šå¼¹å‡ºé€‰æ‹©å¡ç‰‡ï¼ˆå¯æ»šåŠ¨ï¼‰ã€‚ä¸é€‰ä¼šè½»å£°é‡å¤æé†’ã€‚
      </div>
    </section>

    <!-- ç»ˆå±€ï¼šè¶…çº§è¿‡é‡ -->
    <section id="overfullScreen" class="hidden text-center space-y-6 pt-8">
      <div class="text-7xl">ğŸ«£</div>
      <div class="text-2xl font-bold text-gray-800">è¶…çº§è¿‡é‡</div>
      <div class="text-gray-600 text-sm leading-relaxed">
        æˆ‘ä»¬å…ˆåœä¸‹æ¥ã€‚<br />
        åšä¸€æ¬¡æ·±å‘¼å¸ï¼Œå–ç‚¹æ¸©æ°´ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚
      </div>
      <div class="text-gray-400 text-xs">
        è®¡æ—¶ä¸æé†’å·²æš‚åœã€‚åº•éƒ¨é•¿æŒ‰å³å¯ç»“æŸæœ¬æ¬¡ç”¨é¤è®°å½•ã€‚
      </div>
    </section>

    <!-- ç»“æŸé¡µï¼ˆæ— å¼¹çª—ï¼‰ -->
    <section id="endScreen" class="hidden text-center space-y-6 pt-8">
      <div class="text-6xl">âœ…</div>
      <div class="text-xl font-bold text-gray-800">ç”¨é¤å·²ç»“æŸ</div>
      <div id="endSummary" class="text-gray-600 text-sm leading-relaxed"></div>

      <button id="restartBtn"
        class="btn-bounce bg-orange-500 text-white w-full max-w-sm mx-auto px-10 py-4 rounded-full text-lg font-semibold shadow-lg active:bg-orange-600">
        å†æ¥ä¸€æ¬¡
      </button>
    </section>
  </main>

  <!-- é€‰æ‹©å¼¹å±‚ï¼ˆå°å±ä¹Ÿèƒ½çœ‹åˆ°æ‰€æœ‰é€‰é¡¹ï¼šå¯æ»šåŠ¨ï¼‰ -->
  <div id="choiceSheet" class="hidden fixed inset-0 z-40">
    <!-- é®ç½© -->
    <div class="absolute inset-0 bg-black/30"></div>

    <!-- åº•éƒ¨å¡ç‰‡ -->
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl safe-bottom">
      <div class="px-5 pt-5 pb-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold text-gray-900">ä½ ç°åœ¨æœ‰å‡ æˆé¥±è…¹æ„Ÿï¼Ÿ</div>
            <div class="text-xs text-gray-400 mt-1">ä¸é€‰ä¼šè½»å£°é‡å¤æé†’</div>
          </div>
          <div class="text-xs text-gray-400 no-select" id="choiceHint"></div>
        </div>

        <!-- é€‰é¡¹åŒºï¼šå¼ºåˆ¶å¯æ»šåŠ¨ï¼Œé¿å…å°å±çœ‹ä¸åˆ° -->
        <div id="optionsContainer"
             class="mt-4 grid grid-cols-1 gap-3 overflow-y-auto"
             style="max-height: 44vh;">
        </div>

        <!-- å°å±ä¼˜åŒ–ï¼šç»™åº•éƒ¨ç•™ç©ºé—´ï¼Œé˜²æ­¢è¢«å›ºå®šæ æŒ¡ä½ -->
        <div class="h-2"></div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œæ ï¼ˆé•¿æŒ‰ç»“æŸï¼‰ -->
  <div id="bottomBar" class="fixed left-0 right-0 bottom-0 z-30 bg-white/95 backdrop-blur border-t safe-bottom">
    <div class="px-4 py-3 flex items-center justify-center">
      <button id="endBtn"
        class="relative overflow-hidden btn-bounce w-full max-w-sm bg-white border-2 border-gray-200 text-gray-800 px-8 py-4 rounded-full text-lg font-semibold shadow-md active:bg-gray-100 disabled:opacity-40 disabled:active:bg-white">
        <!-- é•¿æŒ‰è¿›åº¦å±‚ -->
        <div id="endProgress"
             class="absolute inset-0 bg-orange-100"
             style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;">
        </div>
        <span id="endBtnLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
      </button>
    </div>
  </div>

  <script>
    /* =========================================================
       âœ… ä½ è¦æ”¹â€œç¬¬ä¸€è½®/æ¯è½®â€çš„æ—¶é—´ï¼šåªæ”¹ä¸‹é¢ä¸¤è¡Œ
       ========================================================= */
    const FIRST_CHECK_MS = 10 * 1000; // ç¬¬ä¸€è½®æé†’ï¼š10ç§’ï¼ˆæµ‹è¯•ç”¨ï¼‰
    const NEXT_CHECK_MS  = 5  * 1000; // åç»­æ¯è½®ï¼š5ç§’ï¼ˆæµ‹è¯•ç”¨ï¼‰

    /* ä¸é€‰æ‹©æ—¶æŒç»­æé†’é¢‘ç‡ï¼ˆå¯æ”¹ï¼‰ */
    const REMINDER_EVERY_MS = 10 * 1000;

    /* ç»“æŸæŒ‰é’®é•¿æŒ‰æ—¶é•¿ï¼ˆå¯æ”¹ï¼‰ */
    const LONG_PRESS_MS = 1000;

    /* å¯é€‰ï¼šéœ‡åŠ¨ï¼ˆæ‰‹æœºæ”¯æŒæ‰ä¼šç”Ÿæ•ˆï¼‰ */
    const ENABLE_VIBRATE = true;
    const VIBRATE_PATTERN = [25];

    /* å¯é€‰ï¼šTTSä¸è¡Œæ—¶ç”¨æŸ”å’Œæç¤ºéŸ³ï¼ˆWebAudioï¼‰ */
    const ENABLE_BEEP_FALLBACK = true;

    // ====== çŠ¶æ€ ======
    let startTime = null;
    let timerInterval = null;
    let nextCheckTimeout = null;
    let reminderInterval = null;

    let lastKeyForNext = "";
    let isWaitingForChoice = false;
    let hasStarted = false;
    let hasEnded = false;

    // WebAudioï¼ˆç”¨äºæŸ”å’Œæç¤ºéŸ³ï¼‰
    let audioCtx = null;
    let audioUnlocked = false;

    // é•¿æŒ‰ç»“æŸ
    let pressTimer = null;
    let pressing = false;

    // ====== DOM ======
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');

    const startScreen = document.getElementById('startScreen');
    const eatingScreen = document.getElementById('eatingScreen');
    const overfullScreen = document.getElementById('overfullScreen');
    const endScreen = document.getElementById('endScreen');
    const endSummary = document.getElementById('endSummary');

    const timerDisplay = document.getElementById('timerDisplay');

    const choiceSheet = document.getElementById('choiceSheet');
    const choiceHint = document.getElementById('choiceHint');
    const optionsContainer = document.getElementById('optionsContainer');

    const logList = document.getElementById('logList');
    const logEmpty = document.getElementById('logEmpty');
    const recordLog = document.getElementById('recordLog');
    const toggleLogBtn = document.getElementById('toggleLogBtn');

    const endBtn = document.getElementById('endBtn');
    const endBtnLabel = document.getElementById('endBtnLabel');
    const endProgress = document.getElementById('endProgress');

    const debugBar = document.getElementById('debugBar');
    function showDebug(msg) {
      debugBar.classList.remove('hidden');
      debugBar.textContent = msg;
    }
    // æ‰‹æœºä¸ŠæŠ“é”™è¯¯ï¼ˆé¿å…â€œæŠ¥é”™å¯¼è‡´è®¡æ—¶ä¸åŠ¨â€å´ä¸çŸ¥é“åŸå› ï¼‰
    window.addEventListener('error', (e) => showDebug('è„šæœ¬é”™è¯¯ï¼š' + (e.message || 'unknown')));
    window.addEventListener('unhandledrejection', (e) => showDebug('Promiseé”™è¯¯ï¼š' + (e.reason?.message || String(e.reason || 'unknown'))));

    // ====== é€‰é¡¹é…ç½®ï¼ˆç”¨ keyï¼Œé¿å…ä¸­æ–‡å­—ç¬¦ä¸²åŒ¹é…æ¼æ‰ï¼‰======
    const LABEL = {
      "<5":  "5æˆé¥±ä»¥ä¸‹",
      "5-6": "5ï¼6æˆ",
      "6-7": "6ï¼7æˆ",
      "7+":  "7æˆä»¥ä¸Š",
      "7-8": "7ï¼8æˆ",
      "8-9": "8ï¼9æˆ",
      "8+":  "8æˆä»¥ä¸Š",
      "9+":  "9æˆä»¥ä¸Š",
      "9-10":"9æˆï¼10æˆ",
      "10+": "10æˆè¿‡é‡",
      "11+": "è¶…çº§è¿‡é‡"
    };

    function normalizeForNext(key) {
      if (key === "7+") return "7-8";
      if (key === "8+") return "8-9";
      if (key === "9+") return "9-10";
      return key;
    }

    function nextOptionsByLast(lastNormalizedKey) {
      if (!lastNormalizedKey || lastNormalizedKey === "<5") return ["<5", "5-6", "6-7", "7+"];

      if (lastNormalizedKey === "5-6") return ["5-6", "6-7", "7-8", "8+"];
      if (lastNormalizedKey === "6-7") return ["6-7", "7-8", "8-9", "9+"];

      if (lastNormalizedKey === "7-8") return ["8-9", "9-10", "10+", "11+"];

      // ä½ æ²¡æ˜ç¡® 8-9 çš„è§„åˆ™ï¼šè¿™é‡Œåšè‡ªç„¶è¡”æ¥ï¼ˆæ›´ç¬¦åˆç›´è§‰ï¼šå†å¾€ä¸Šèµ°ï¼‰
      if (lastNormalizedKey === "8-9") return ["9-10", "10+", "11+"];

      if (lastNormalizedKey === "9-10") return ["9-10", "10+", "11+"];
      if (lastNormalizedKey === "10+") return ["10+", "11+"];
      if (lastNormalizedKey === "11+") return ["11+"];

      return ["9-10", "10+", "11+"];
    }

    // ====== è®¡æ—¶ ======
    function updateTimer() {
      if (!startTime) return;
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, '0');
      const s = String(diff % 60).padStart(2, '0');
      timerDisplay.textContent = `å·²ç”¨æ—¶ï¼š${m}:${s}`;
    }

    // ====== æ—¥å¿—ï¼šæœ€æ–°æ”¾ä¸‹é¢ï¼ˆappendï¼‰======
    function addLog(html) {
      logEmpty.classList.add('hidden');
      const li = document.createElement('li');
      li.className = "leading-relaxed";
      li.innerHTML = html;
      logList.appendChild(li);          // âœ… æœ€æ–°åœ¨ä¸‹é¢
      recordLog.scrollTop = recordLog.scrollHeight; // âœ… è‡ªåŠ¨æ»šåˆ°åº•éƒ¨
    }

    // ====== éœ‡åŠ¨ ======
    function softVibrate() {
      if (!ENABLE_VIBRATE) return;
      if (!('vibrate' in navigator)) return;
      try { navigator.vibrate(VIBRATE_PATTERN); } catch (_) {}
    }

    // ====== WebAudio æŸ”å’Œæç¤ºéŸ³ï¼ˆfallbackï¼‰======
    async function unlockAudio() {
      if (!ENABLE_BEEP_FALLBACK) return;
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        audioCtx = audioCtx || new AC();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        audioUnlocked = true;
      } catch (_) {}
    }

    function softBeep() {
      if (!ENABLE_BEEP_FALLBACK) return;
      if (!audioCtx || !audioUnlocked) return;
      try {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = 660;
        g.gain.value = 0.0001;
        o.connect(g);
        g.connect(audioCtx.destination);

        const t = audioCtx.currentTime;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.02, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

        o.start(t);
        o.stop(t + 0.2);
      } catch (_) {}
    }

    // ====== æŸ”å’Œè¯­éŸ³æé†’ï¼ˆå…¼å®¹è¡¥ä¸ï¼šå¤±è´¥ä¸å½±å“æµç¨‹ï¼‰======
    function canTTS() {
      return ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
    }

    function playSoftNotice() {
      try {
        if (!canTTS()) { softBeep(); return; }
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance("è¯·é—®ä½ ç°åœ¨å‡ æˆé¥±äº†ï¼Ÿ");
        msg.rate = 0.85;
        msg.pitch = 1.0;
        msg.lang = 'zh-CN';
        window.speechSynthesis.speak(msg);
      } catch (_) {
        // âœ… è¯­éŸ³å¤±è´¥ç›´æ¥é™çº§ï¼ˆä¸è®©å®ƒä¸­æ–­è®¡æ—¶ï¼‰
        softBeep();
      }
    }

    // ====== æé†’è°ƒåº¦ ======
    function scheduleNextCheck(ms) {
      clearTimeout(nextCheckTimeout);
      nextCheckTimeout = setTimeout(triggerCheck, ms);
    }

    function openChoiceSheet() {
      choiceSheet.classList.remove('hidden');
    }
    function closeChoiceSheet() {
      choiceSheet.classList.add('hidden');
    }

    function renderOptions() {
      const options = nextOptionsByLast(lastKeyForNext);
      optionsContainer.innerHTML = '';
      choiceHint.textContent = options.length + ' ä¸ªé€‰é¡¹';

      options.forEach(key => {
        const btn = document.createElement('button');
        btn.className =
          "btn-bounce bg-white border-2 border-orange-200 py-3 rounded-xl shadow-sm active:bg-orange-50 transition text-base font-semibold";
        btn.textContent = LABEL[key] || key;
        btn.addEventListener('click', () => makeChoice(key));
        optionsContainer.appendChild(btn);
      });
    }

    function triggerCheck() {
      if (!hasStarted || hasEnded) return;
      if (isWaitingForChoice) return;

      isWaitingForChoice = true;
      renderOptions();
      openChoiceSheet();

      clearInterval(reminderInterval);
      reminderInterval = setInterval(() => {
        if (isWaitingForChoice && !hasEnded) {
          playSoftNotice();
          softVibrate();
        }
      }, REMINDER_EVERY_MS);

      playSoftNotice();
      softVibrate();
    }

    function makeChoice(key) {
      const label = LABEL[key] || key;

      isWaitingForChoice = false;
      closeChoiceSheet();
      clearInterval(reminderInterval);

      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-orange-500 font-mono">${timeStr}</span> ï¼š${label}`);

      lastKeyForNext = normalizeForNext(key);

      // âœ… ç»ˆå±€ï¼šè¶…çº§è¿‡é‡ï¼ˆä¸å¼¹çª—ï¼Œç›´æ¥è¿›å…¥ç»ˆå±€å± + åœæ­¢è®¡æ—¶/æé†’ï¼‰
      if (lastKeyForNext === "11+") {
        enterOverfullState();
        return;
      }

      scheduleNextCheck(NEXT_CHECK_MS);
    }

    function enterOverfullState() {
      // åœæ­¢æ‰€æœ‰è®¡æ—¶å’Œæé†’
      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      // å…³é—­é€‰æ‹©å¼¹å±‚ï¼ˆè‹¥è¿˜å¼€ç€ï¼‰
      isWaitingForChoice = false;
      closeChoiceSheet();

      // åˆ‡æ¢ç»ˆå±€ç”»é¢
      eatingScreen.classList.add('hidden');
      overfullScreen.classList.remove('hidden');

      // æŒ‰é’®æ–‡æ¡ˆæ›´æ˜ç¡®
      endBtnLabel.textContent = "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå·²æš‚åœï¼‰";
    }

    // ====== å¼€å§‹/ç»“æŸï¼ˆé•¿æŒ‰ï¼‰ ======
    async function startEating() {
      if (hasStarted) return;
      hasStarted = true;
      hasEnded = false;

      startTime = new Date();

      startScreen.classList.add('hidden');
      eatingScreen.classList.remove('hidden');

      // âœ… å…ˆå¯åŠ¨è®¡æ—¶ï¼ˆæ— è®ºè¯­éŸ³æ˜¯å¦æ”¯æŒéƒ½èƒ½è®¡æ—¶ï¼‰
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      // âœ… è§£é”éŸ³é¢‘ï¼ˆå¿…é¡»ç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼Œå®‰å“æ›´ç¨³ï¼‰
      await unlockAudio();

      // âœ… è¯•æ’­ä¸€æ¬¡ï¼ˆå¤±è´¥ä¹Ÿä¸å½±å“ï¼‰
      try { playSoftNotice(); } catch (_) {}
      try { if (window.speechSynthesis) window.speechSynthesis.cancel(); } catch (_) {}

      scheduleNextCheck(FIRST_CHECK_MS);
      endBtn.disabled = false;

      addLog(`<span class="text-gray-400 font-mono">00åˆ†00ç§’</span> ï¼šå¼€å§‹ç”¨é¤`);
    }

    function finalizeEnd() {
      if (!hasStarted || hasEnded) return;
      hasEnded = true;

      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      isWaitingForChoice = false;
      closeChoiceSheet();

      // è®°å½•ç»“æŸ
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-gray-400 font-mono">${timeStr}</span> ï¼šç»“æŸç”¨é¤ âœ…`);

      // å±•ç¤ºç»“æŸé¡µï¼ˆä¸å¼¹çª—ï¼‰
      startScreen.classList.add('hidden');
      eatingScreen.classList.add('hidden');
      overfullScreen.classList.add('hidden');
      endScreen.classList.remove('hidden');

      // å°æ€»ç»“ï¼ˆç”¨æˆ·è§†è§’ï¼šç»™ç»“æŸä¸€ä¸ªâ€œæ”¶å£â€ï¼‰
      endSummary.innerHTML = `æœ¬æ¬¡ç”¨é¤ç”¨æ—¶ï¼š<span class="font-semibold text-gray-800">${timeStr}</span><br/>è®°å½•å·²ä¿ç•™åœ¨ä¸Šæ–¹åˆ—è¡¨ä¸­ã€‚`;

      // ç¦ç”¨é•¿æŒ‰æŒ‰é’®ï¼ˆé¿å…è¯¯æ“ä½œï¼‰
      endBtn.disabled = true;
      endBtnLabel.textContent = "å·²ç»“æŸ";
      endProgress.style.transform = "scaleX(0)";
    }

    // ====== é•¿æŒ‰äº¤äº’ï¼ˆ1ç§’ï¼‰ ======
    function setProgress(p) {
      const clamped = Math.max(0, Math.min(1, p));
      endProgress.style.transform = `scaleX(${clamped})`;
    }

    function startPress() {
      if (endBtn.disabled) return;
      if (!hasStarted || hasEnded) return;

      pressing = true;
      endBtnLabel.textContent = "ç»§ç»­æŒ‰ä½â€¦";
      softVibrate();

      const start = Date.now();
      setProgress(0);

      // ç”¨ interval æ¨¡æ‹Ÿè¿›åº¦ï¼ˆå…¼å®¹è€æœºï¼‰
      pressTimer = setInterval(() => {
        const elapsed = Date.now() - start;
        const p = elapsed / LONG_PRESS_MS;
        setProgress(p);
        if (elapsed >= LONG_PRESS_MS) {
          clearInterval(pressTimer);
          pressTimer = null;
          pressing = false;
          setProgress(1);
          finalizeEnd();
        }
      }, 16);
    }

    function cancelPress() {
      if (!pressing) return;
      pressing = false;

      if (pressTimer) {
        clearInterval(pressTimer);
        pressTimer = null;
      }

      // å¤ä½è§†è§‰çŠ¶æ€
      setProgress(0);
      endBtnLabel.textContent = (overfullScreen.classList.contains('hidden'))
        ? "é•¿æŒ‰ 1 ç§’ç»“æŸ"
        : "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå·²æš‚åœï¼‰";
    }

    // ç»‘å®šï¼šé•¿æŒ‰éœ€è¦åœ¨ touch/mouse éƒ½å…¼å®¹
    endBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(); }, { passive: false });
    endBtn.addEventListener('touchend', cancelPress);
    endBtn.addEventListener('touchcancel', cancelPress);

    endBtn.addEventListener('mousedown', startPress);
    endBtn.addEventListener('mouseup', cancelPress);
    endBtn.addEventListener('mouseleave', cancelPress);

    // ====== æŠ˜å è®°å½•åŒº ======
    let logCollapsed = false;
    toggleLogBtn.addEventListener('click', () => {
      logCollapsed = !logCollapsed;
      if (logCollapsed) {
        recordLog.classList.add('hidden');
        toggleLogBtn.textContent = 'å±•å¼€';
      } else {
        recordLog.classList.remove('hidden');
        toggleLogBtn.textContent = 'æŠ˜å ';
        recordLog.scrollTop = recordLog.scrollHeight;
      }
    });

    // ====== é‡æ¥ä¸€æ¬¡ ======
    restartBtn.addEventListener('click', () => location.reload());

    // ====== ç»‘å®šå¼€å§‹æŒ‰é’® ======
    startBtn.addEventListener('click', startEating);

    // åˆå§‹åŒ–ï¼šç»“æŸæŒ‰é’®ç¦ç”¨
    endBtn.disabled = true;
  </script>
</body>
</html>


