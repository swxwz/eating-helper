<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-select { -webkit-user-select:none; user-select:none; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

  <header id="topHeader" class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b">
    <div class="px-4 pt-3 pb-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ç”¨é¤è§‰å¯Ÿè®°å½•</div>
        <button id="toggleLogBtn"
          class="text-sm text-orange-600 font-medium btn-bounce px-3 py-2 rounded-lg active:bg-orange-50">
          æŠ˜å 
        </button>
      </div>

      <div id="recordLog" class="mt-2 max-h-32 overflow-y-auto text-sm text-gray-600">
        <ul id="logList" class="space-y-1"></ul>
        <div id="logEmpty" class="text-gray-400 py-2">è¿˜æ²¡æœ‰è®°å½•ã€‚å¼€å§‹åƒé¥­åä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡é€‰æ‹©ã€‚</div>
      </div>
    </div>
  </header>

  <main class="px-5 pt-6 pb-28">

    <section id="startScreen" class="text-center space-y-5">
      <div class="text-6xl">ğŸ±</div>
      <div class="text-gray-800 font-semibold text-xl">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</div>
      <div class="text-gray-500 text-sm leading-relaxed">
        ä½ çš„ç›®æ ‡æ˜¯ <span class="font-semibold text-gray-800">7æˆé¥±</span>ã€‚<br />
        ç³»ç»Ÿä¼šå®šæ—¶ç”¨è½»æç¤ºéŸ³æé†’ä½ åšé€‰æ‹©ã€‚
      </div>

      <button id="startBtn"
        class="btn-bounce bg-orange-500 text-white w-full max-w-sm mx-auto px-10 py-4 rounded-full text-xl font-bold shadow-lg active:bg-orange-600">
        å¼€å§‹åƒé¥­
      </button>

      <div class="text-xs text-gray-400 leading-relaxed">
        æç¤ºï¼šç‚¹å‡»åè‹¥æ— ååº”ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å…è®¸éŸ³é¢‘æ’­æ”¾ã€‚
      </div>
    </section>

    <section id="eatingScreen" class="hidden text-center space-y-4">
      <div class="relative w-44 h-44 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-6xl animate-bounce">ğŸ¥¢</div>
      </div>
      <div id="timerDisplay" class="text-gray-700 text-sm font-medium">å·²ç”¨æ—¶ï¼š00:00</div>
      <div id="statusBanner" class="hidden mx-auto max-w-sm rounded-2xl border bg-white px-4 py-4 shadow-sm text-left">
        <div id="statusTitle" class="text-base font-extrabold text-gray-900"></div>
        <div id="statusText" class="mt-1 text-sm font-semibold text-gray-700 leading-relaxed"></div>
      </div>
    </section>

    <section id="overfullScreen" class="hidden text-center space-y-6 pt-8">
      <div class="mx-auto w-28 h-28 rounded-full bg-orange-50 flex items-center justify-center shadow-inner">
        <div class="text-5xl">âš ï¸</div>
      </div>
      <div class="text-3xl font-extrabold text-gray-900">è¶…çº§è¿‡é‡</div>
      <div class="text-gray-800 text-lg font-semibold leading-relaxed">ç°åœ¨å…ˆåœä¸‹æ¥ã€‚æ·±å‘¼å¸ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚</div>
    </section>

    <section id="endTransitionScreen" class="hidden text-center space-y-6 pt-12">
      <div class="text-6xl">âœ¨</div>
      <div class="text-2xl font-extrabold text-gray-900">æ­å–œä½ ï¼Œåº¦è¿‡äº†äººç”Ÿä¸­çš„ä¸€é¤</div>
      <div id="endTransitionText" class="text-gray-800 text-lg font-semibold leading-relaxed"></div>
      <div class="text-gray-500 text-sm">5 ç§’åè¿”å›å¼€å§‹é¡µé¢â€¦</div>
    </section>
  </main>

  <div id="choiceSheet" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl safe-bottom">
      <div class="px-5 pt-5 pb-4">
        <div class="text-lg font-semibold text-gray-900 mb-4">ä½ ç°åœ¨æœ‰å‡ æˆé¥±è…¹æ„Ÿï¼Ÿ</div>
        <div id="optionsContainer" class="grid grid-cols-1 gap-3 overflow-y-auto" style="max-height: 52vh;"></div>
        <div id="sheetEndWrap" class="hidden mt-4">
          <button id="sheetEndBtn" class="relative overflow-hidden w-full btn-bounce bg-white border-2 border-orange-200 text-orange-700 py-4 rounded-2xl font-extrabold">
            <div id="sheetEndProgress" class="absolute inset-0 bg-orange-100" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
            <span class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸç”¨é¤</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="bottomBar" class="fixed left-0 right-0 bottom-0 z-30 bg-white/95 backdrop-blur border-t safe-bottom">
    <div class="px-4 py-3 flex items-center justify-center">
      <button id="endBtn" class="relative overflow-hidden btn-bounce w-full max-w-sm bg-white border-2 border-gray-200 text-gray-900 py-4 rounded-full text-lg font-semibold shadow-md disabled:opacity-40">
        <div id="endProgress" class="absolute inset-0 bg-orange-100" style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;"></div>
        <span id="endBtnLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
      </button>
    </div>
  </div>

  <script>
    /* é…ç½®åŒº */
    const FIRST_CHECK_MS = 10000; // æµ‹è¯•ç”¨ 10ç§’
    const NEXT_CHECK_MS  = 5000;  // æµ‹è¯•ç”¨ 5ç§’
    const REMINDER_EVERY_MS = 10000;
    const LONG_PRESS_MS = 1000;
    const CHIME_VOLUME = 0.8;

    let startTime = null, timerInterval = null, nextCheckTimeout = null, reminderInterval = null;
    let lastKeyForNext = "", lastChoiceLabel = "", isWaitingForChoice = false, hasStarted = false, hasEnded = false;
    let audioCtx = null, compressor = null, masterGain = null, audioUnlocked = false;

    const LABEL = { "<5": "5æˆé¥±ä»¥ä¸‹", "5-6": "5ï¼6æˆ", "6-7": "6ï¼7æˆ", "7-goal": "7æˆï¼ˆè¾¾æˆç›®æ ‡ï¼‰", "7-8": "7ï¼8æˆ", "8-9": "8ï¼9æˆ", "8+": "8æˆä»¥ä¸Š", "9+": "9æˆä»¥ä¸Š", "9-10": "9æˆï¼10æˆ", "10+": "10æˆè¿‡é‡", "11+": "è¶…çº§è¿‡é‡" };

    function unlockAudio() {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC || audioUnlocked) return;
      audioCtx = new AC();
      compressor = audioCtx.createDynamicsCompressor();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = CHIME_VOLUME;
      compressor.connect(masterGain);
      masterGain.connect(audioCtx.destination);
      if (audioCtx.state === 'suspended') audioCtx.resume();
      audioUnlocked = true;
    }

    function playChime() {
      if (!audioUnlocked) return;
      const now = audioCtx.currentTime;
      const t = (f, s, d, p) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "triangle";
        o.frequency.setValueAtTime(f, s);
        g.gain.setValueAtTime(0.001, s);
        g.gain.exponentialRampToValueAtTime(p, s + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, s + d);
        o.connect(g); g.connect(compressor);
        o.start(s); o.stop(s + d + 0.05);
      };
      t(523.25, now, 0.2, 0.5);
      t(659.25, now + 0.2, 0.2, 0.5);
    }

    function startEating() {
      if (hasStarted) return;
      unlockAudio(); // å¿…é¡»åœ¨ç‚¹å‡»äº‹ä»¶çš„ç¬¬ä¸€è¡ŒåŒæ­¥æ‰§è¡Œ
      hasStarted = true;
      startTime = new Date();
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('eatingScreen').classList.remove('hidden');
      timerInterval = setInterval(() => {
        const d = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('timerDisplay').textContent = `å·²ç”¨æ—¶ï¼š${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
      }, 1000);
      setTimeout(triggerCheck, FIRST_CHECK_MS);
      playChime();
      document.getElementById('endBtn').disabled = false;
    }

    function triggerCheck() {
      if (!hasStarted || hasEnded || isWaitingForChoice) return;
      isWaitingForChoice = true;
      document.getElementById('choiceSheet').classList.remove('hidden');
      renderOptions();
      playChime();
      reminderInterval = setInterval(() => { if(isWaitingForChoice) playChime(); }, REMINDER_EVERY_MS);
    }

    function renderOptions() {
      const getOpts = (k) => {
        if (!k || k === "<5") return ["<5", "5-6", "6-7", "7-goal", "7-8"];
        if (k === "5-6") return ["5-6", "6-7", "7-goal", "7-8", "8+"];
        if (k === "6-7") return ["6-7", "7-goal", "7-8", "8-9", "9+"];
        return ["9-10", "10+", "11+"];
      };
      const container = document.getElementById('optionsContainer');
      container.innerHTML = '';
      getOpts(lastKeyForNext).forEach(key => {
        const btn = document.createElement('button');
        btn.className = "bg-white border-2 border-orange-200 py-4 rounded-xl font-extrabold active:bg-orange-50";
        btn.textContent = LABEL[key];
        btn.onclick = () => {
          lastKeyForNext = key;
          lastChoiceLabel = LABEL[key];
          isWaitingForChoice = false;
          document.getElementById('choiceSheet').classList.add('hidden');
          clearInterval(reminderInterval);
          const diff = Math.floor((Date.now() - startTime) / 1000);
          const li = document.createElement('li');
          li.innerHTML = `<span class="text-orange-500 font-mono">${Math.floor(diff/60)}åˆ†${diff%60}ç§’</span>ï¼š${LABEL[key]}`;
          document.getElementById('logList').appendChild(li);
          document.getElementById('logEmpty').classList.add('hidden');
          if (key === "11+") {
             hasEnded = true;
             document.getElementById('eatingScreen').classList.add('hidden');
             document.getElementById('overfullScreen').classList.remove('hidden');
          } else {
             setTimeout(triggerCheck, NEXT_CHECK_MS);
          }
        };
        container.appendChild(btn);
      });
    }

    function bindLongPress(btn, progressEl, onComplete) {
      let t = null, start = 0;
      const begin = (e) => { e.preventDefault(); start = Date.now(); t = setInterval(() => {
        const p = (Date.now() - start) / LONG_PRESS_MS;
        progressEl.style.transform = `scaleX(${Math.min(p, 1)})`;
        if (p >= 1) { clearInterval(t); onComplete(); }
      }, 20); };
      const stop = () => { clearInterval(t); progressEl.style.transform = 'scaleX(0)'; };
      btn.addEventListener('touchstart', begin); btn.addEventListener('touchend', stop);
      btn.addEventListener('mousedown', begin); btn.addEventListener('mouseup', stop);
    }

    bindLongPress(document.getElementById('endBtn'), document.getElementById('endProgress'), () => {
      hasEnded = true;
      document.getElementById('eatingScreen').classList.add('hidden');
      document.getElementById('overfullScreen').classList.add('hidden');
      document.getElementById('endTransitionScreen').classList.remove('hidden');
      document.getElementById('endTransitionText').textContent = `æœ¬æ¬¡è®°å½•ï¼š${lastChoiceLabel || 'è¿›è¡Œä¸­'}`;
      setTimeout(() => location.reload(), 5000);
    });

    document.getElementById('startBtn').addEventListener('click', startEating);
    document.getElementById('toggleLogBtn').onclick = () => {
      const el = document.getElementById('recordLog');
      el.classList.toggle('hidden');
      document.getElementById('toggleLogBtn').textContent = el.classList.contains('hidden') ? 'å±•å¼€' : 'æŠ˜å ';
    };
  </script>
</body>
</html>
