<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .eating-bg { background: radial-gradient(circle, #fffbeb 0%, #fef3c7 100%); }
    .btn-bounce { transition: transform 0.12s; }
    .btn-bounce:active { transform: scale(0.97); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .no-select { -webkit-user-select:none; user-select:none; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

  <!-- é¡¶éƒ¨è®°å½•åŒºï¼ˆå¯æŠ˜å ï¼‰ -->
  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b">
    <div class="px-4 pt-3 pb-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold text-gray-700">ç”¨é¤è§‰å¯Ÿè®°å½•</div>
        <button id="toggleLogBtn"
          class="text-sm text-orange-600 font-medium btn-bounce px-3 py-2 rounded-lg active:bg-orange-50">
          æŠ˜å 
        </button>
      </div>

      <div id="recordLog" class="mt-2 max-h-32 overflow-y-auto text-sm text-gray-600">
        <ul id="logList" class="space-y-1"></ul>
        <div id="logEmpty" class="text-gray-400 py-2">è¿˜æ²¡æœ‰è®°å½•ã€‚å¼€å§‹åƒé¥­åä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡é€‰æ‹©ã€‚</div>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹ -->
  <main class="px-5 pt-6 pb-28">
    <!-- å¼€å§‹é¡µ -->
    <section id="startScreen" class="text-center space-y-5">
      <div class="text-6xl">ğŸ±</div>
      <div class="text-gray-800 font-semibold text-xl">é¥®é£Ÿè§‰å¯ŸåŠ©æ‰‹</div>
      <div class="text-gray-500 text-sm leading-relaxed">
        åƒåˆ°åˆé€‚çš„é¥±å°±åœä¸‹ã€‚<br />
        ç³»ç»Ÿä¼šå®šæ—¶ç”¨è½»æç¤ºéŸ³æé†’ä½ é€‰æ‹©ã€‚
      </div>

      <button id="startBtn"
        class="btn-bounce bg-orange-500 text-white w-full max-w-sm mx-auto px-10 py-4 rounded-full text-xl font-bold shadow-lg active:bg-orange-600">
        å¼€å§‹åƒé¥­
      </button>

      <div class="text-xs text-gray-400 leading-relaxed">
        æç¤ºï¼šä¸ºäº†å…¼å®¹è€å®‰å“ï¼Œæœ¬å·¥å…·ä½¿ç”¨â€œ1ç§’å†…è½»éŸ³ä¹æç¤ºéŸ³â€ä»£æ›¿è¯­éŸ³æé†’ã€‚
      </div>
    </section>

    <!-- åƒé¥­ä¸­ -->
    <section id="eatingScreen" class="hidden text-center space-y-4">
      <div class="relative w-44 h-44 mx-auto bg-white rounded-full flex items-center justify-center shadow-inner eating-bg">
        <div class="text-6xl animate-bounce">ğŸ¥¢</div>
      </div>

      <div id="timerDisplay" class="text-gray-700 text-sm font-medium">å·²ç”¨æ—¶ï¼š00:00</div>

      <div class="text-gray-400 text-xs leading-relaxed">
        åˆ°æ—¶é—´ä¼šå¼¹å‡ºé€‰æ‹©å¡ç‰‡ï¼ˆå¯æ»šåŠ¨ï¼‰ã€‚ä¸é€‰ä¼šè½»å£°é‡å¤æé†’ã€‚
      </div>
    </section>

    <!-- ç»ˆå±€ï¼šè¶…çº§è¿‡é‡ -->
    <section id="overfullScreen" class="hidden text-center space-y-6 pt-8">
      <!-- å†…ç½® SVG Logoï¼ˆä¸ä¾èµ– emoji å­—ä½“ï¼‰ -->
      <div class="mx-auto w-28 h-28 rounded-full bg-orange-50 flex items-center justify-center shadow-inner">
        <svg width="64" height="64" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="#fb923c"/>
              <stop offset="1" stop-color="#f97316"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="28" fill="url(#g)" opacity="0.15"/>
          <path d="M32 10 L56 52 H8 Z" fill="url(#g)" opacity="0.95"/>
          <rect x="30.3" y="23" width="3.4" height="16" rx="1.7" fill="#fff"/>
          <circle cx="32" cy="44.5" r="2.2" fill="#fff"/>
        </svg>
      </div>

      <div class="text-3xl font-extrabold text-gray-900">è¶…çº§è¿‡é‡</div>

      <div class="text-gray-800 text-lg font-semibold leading-relaxed">
        ç°åœ¨å…ˆåœä¸‹æ¥ã€‚<br />
        æ·±å‘¼å¸ 3 æ¬¡ï¼Œå–ä¸€ç‚¹æ¸©æ°´ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚
      </div>

      <div class="text-gray-500 text-sm leading-relaxed">
        è®¡æ—¶ä¸æé†’å·²æš‚åœã€‚<br />
        åº•éƒ¨<strong>é•¿æŒ‰ 1 ç§’</strong>å³å¯ç»“æŸæœ¬æ¬¡è®°å½•ã€‚
      </div>
    </section>
  </main>

  <!-- é€‰æ‹©å¼¹å±‚ï¼ˆå°å±ä¹Ÿèƒ½çœ‹åˆ°æ‰€æœ‰é€‰é¡¹ï¼šå¯æ»šåŠ¨ï¼‰ -->
  <div id="choiceSheet" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/30"></div>

    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl safe-bottom">
      <div class="px-5 pt-5 pb-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold text-gray-900">ä½ ç°åœ¨æœ‰å‡ æˆé¥±è…¹æ„Ÿï¼Ÿ</div>
            <div class="text-xs text-gray-400 mt-1">ä¸é€‰ä¼šè½»å£°é‡å¤æé†’</div>
          </div>
          <div class="text-xs text-gray-400 no-select" id="choiceHint"></div>
        </div>

        <!-- å°å±å…³é”®ï¼šé«˜åº¦æ›´å¤§ + å¯æ»šåŠ¨ -->
        <div id="optionsContainer"
             class="mt-4 grid grid-cols-1 gap-3 overflow-y-auto"
             style="max-height: 52vh;">
        </div>

        <div class="h-2"></div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œæ ï¼ˆé•¿æŒ‰ç»“æŸï¼‰ -->
  <div id="bottomBar" class="fixed left-0 right-0 bottom-0 z-30 bg-white/95 backdrop-blur border-t safe-bottom">
    <div class="px-4 py-3 flex items-center justify-center">
      <button id="endBtn"
        class="relative overflow-hidden btn-bounce w-full max-w-sm bg-white border-2 border-gray-200 text-gray-900 px-8 py-4 rounded-full text-lg font-semibold shadow-md active:bg-gray-100 disabled:opacity-40 disabled:active:bg-white">
        <div id="endProgress"
             class="absolute inset-0 bg-orange-100"
             style="transform: scaleX(0); transform-origin: left; transition: transform 80ms linear;">
        </div>
        <span id="endBtnLabel" class="relative">é•¿æŒ‰ 1 ç§’ç»“æŸ</span>
      </button>
    </div>
  </div>

  <script>
    /* =========================================================
       âœ… ä¿®æ”¹æ—¶é—´ï¼šåªæ”¹ä¸‹é¢ä¸¤è¡Œ
       ========================================================= */
    const FIRST_CHECK_MS = 10 * 1000; // ç¬¬ä¸€è½®æé†’ï¼ˆæµ‹è¯• 10sï¼‰
    const NEXT_CHECK_MS  = 5  * 1000; // åç»­æ¯è½®ï¼ˆæµ‹è¯• 5sï¼‰

    /* ä¸é€‰æ‹©æ—¶æŒç»­æé†’é¢‘ç‡ */
    const REMINDER_EVERY_MS = 10 * 1000;

    /* é•¿æŒ‰ç»“æŸæ—¶é•¿ */
    const LONG_PRESS_MS = 1000;

    /* å¯é€‰ï¼šéœ‡åŠ¨ï¼ˆæ‰‹æœºæ”¯æŒæ‰ä¼šç”Ÿæ•ˆï¼‰ */
    const ENABLE_VIBRATE = true;
    const VIBRATE_PATTERN = [25];

    /* è½»éŸ³ä¹æç¤ºéŸ³ï¼ˆWebAudioï¼‰ */
    const ENABLE_CHIME = true;

    // ====== çŠ¶æ€ ======
    let startTime = null;
    let timerInterval = null;
    let nextCheckTimeout = null;
    let reminderInterval = null;

    let lastKeyForNext = "";
    let isWaitingForChoice = false;
    let hasStarted = false;
    let hasEnded = false;

    // WebAudio
    let audioCtx = null;
    let audioUnlocked = false;

    // é•¿æŒ‰ç»“æŸ
    let pressTimer = null;
    let pressing = false;

    // ====== DOM ======
    const startBtn = document.getElementById('startBtn');
    const startScreen = document.getElementById('startScreen');
    const eatingScreen = document.getElementById('eatingScreen');
    const overfullScreen = document.getElementById('overfullScreen');

    const timerDisplay = document.getElementById('timerDisplay');

    const choiceSheet = document.getElementById('choiceSheet');
    const choiceHint = document.getElementById('choiceHint');
    const optionsContainer = document.getElementById('optionsContainer');

    const logList = document.getElementById('logList');
    const logEmpty = document.getElementById('logEmpty');
    const recordLog = document.getElementById('recordLog');
    const toggleLogBtn = document.getElementById('toggleLogBtn');

    const endBtn = document.getElementById('endBtn');
    const endBtnLabel = document.getElementById('endBtnLabel');
    const endProgress = document.getElementById('endProgress');

    // ====== é€‰é¡¹é…ç½®ï¼ˆç”¨ keyï¼‰======
    const LABEL = {
      "<5":  "5æˆé¥±ä»¥ä¸‹",
      "5-6": "5ï¼6æˆ",
      "6-7": "6ï¼7æˆ",
      "7+":  "7æˆä»¥ä¸Š",
      "7-8": "7ï¼8æˆ",
      "8-9": "8ï¼9æˆ",
      "8+":  "8æˆä»¥ä¸Š",
      "9+":  "9æˆä»¥ä¸Š",
      "9-10":"9æˆï¼10æˆ",
      "10+": "10æˆè¿‡é‡",
      "11+": "è¶…çº§è¿‡é‡"
    };

    function normalizeForNext(key) {
      if (key === "7+") return "7-8";
      if (key === "8+") return "8-9";
      if (key === "9+") return "9-10";
      return key;
    }

    function nextOptionsByLast(lastNormalizedKey) {
      if (!lastNormalizedKey || lastNormalizedKey === "<5") return ["<5", "5-6", "6-7", "7+"];
      if (lastNormalizedKey === "5-6") return ["5-6", "6-7", "7-8", "8+"];
      if (lastNormalizedKey === "6-7") return ["6-7", "7-8", "8-9", "9+"];
      if (lastNormalizedKey === "7-8") return ["8-9", "9-10", "10+", "11+"];
      if (lastNormalizedKey === "8-9") return ["9-10", "10+", "11+"];
      if (lastNormalizedKey === "9-10") return ["9-10", "10+", "11+"];
      if (lastNormalizedKey === "10+") return ["10+", "11+"];
      if (lastNormalizedKey === "11+") return ["11+"];
      return ["9-10", "10+", "11+"];
    }

    // ====== è®¡æ—¶ ======
    function updateTimer() {
      if (!startTime) return;
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, '0');
      const s = String(diff % 60).padStart(2, '0');
      timerDisplay.textContent = `å·²ç”¨æ—¶ï¼š${m}:${s}`;
    }

    // ====== æ—¥å¿—ï¼šæœ€æ–°æ”¾ä¸‹é¢ ======
    function addLog(html) {
      logEmpty.classList.add('hidden');
      const li = document.createElement('li');
      li.className = "leading-relaxed";
      li.innerHTML = html;
      logList.appendChild(li);
      recordLog.scrollTop = recordLog.scrollHeight;
    }

    // ====== éœ‡åŠ¨ ======
    function softVibrate() {
      if (!ENABLE_VIBRATE) return;
      if (!('vibrate' in navigator)) return;
      try { navigator.vibrate(VIBRATE_PATTERN); } catch (_) {}
    }

    // ====== WebAudio è§£é” ======
    async function unlockAudio() {
      if (!ENABLE_CHIME) return;
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        audioCtx = audioCtx || new AC();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        audioUnlocked = true;
      } catch (_) {
        // é™é»˜å¤±è´¥ï¼šä¸å½±å“è®¡æ—¶
      }
    }

    // ====== 1ç§’å†…è½»éŸ³ä¹æç¤ºéŸ³ï¼ˆçŸ­ chimeï¼‰======
    function playChime() {
      if (!ENABLE_CHIME) return;
      if (!audioCtx || !audioUnlocked) return;

      try {
        const now = audioCtx.currentTime;

        function tone(freq, start, dur, peak=0.03) {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(freq, start);
          g.gain.setValueAtTime(0.0001, start);
          g.gain.exponentialRampToValueAtTime(peak, start + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, start + dur);
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start(start);
          o.stop(start + dur + 0.01);
        }

        // ä¸¤ä¸ªéŸ³ç¬¦ï¼ˆæ€»æ—¶é•¿ < 1sï¼‰ï¼Œæ›´åƒâ€œè½»éŸ³ä¹æé†’â€è€Œä¸æ˜¯å“”å£°
        tone(523.25, now + 0.00, 0.18, 0.028); // C5
        tone(659.25, now + 0.22, 0.22, 0.030); // E5
      } catch (_) {
        // é™é»˜å¤±è´¥
      }
    }

    // ç»Ÿä¸€æé†’å…¥å£ï¼ˆä¸å†è¯­éŸ³ï¼‰
    function notifyUser() {
      playChime();
      softVibrate();
    }

    // ====== è°ƒåº¦ ======
    function scheduleNextCheck(ms) {
      clearTimeout(nextCheckTimeout);
      nextCheckTimeout = setTimeout(triggerCheck, ms);
    }

    function openChoiceSheet() {
      choiceSheet.classList.remove('hidden');
    }
    function closeChoiceSheet() {
      choiceSheet.classList.add('hidden');
    }

    function renderOptions() {
      const options = nextOptionsByLast(lastKeyForNext);
      optionsContainer.innerHTML = '';
      choiceHint.textContent = options.length + ' ä¸ªé€‰é¡¹';

      options.forEach(key => {
        const btn = document.createElement('button');
        btn.className = "btn-bounce bg-white border-2 border-orange-200 py-3 rounded-xl shadow-sm active:bg-orange-50 transition text-base font-semibold";
        btn.textContent = LABEL[key] || key;
        btn.addEventListener('click', () => makeChoice(key));
        optionsContainer.appendChild(btn);
      });
    }

    function triggerCheck() {
      if (!hasStarted || hasEnded) return;
      if (isWaitingForChoice) return;

      isWaitingForChoice = true;
      renderOptions();
      openChoiceSheet();

      clearInterval(reminderInterval);
      reminderInterval = setInterval(() => {
        if (isWaitingForChoice && !hasEnded) notifyUser();
      }, REMINDER_EVERY_MS);

      notifyUser();
    }

    function makeChoice(key) {
      const label = LABEL[key] || key;

      isWaitingForChoice = false;
      closeChoiceSheet();
      clearInterval(reminderInterval);

      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-orange-500 font-mono">${timeStr}</span> ï¼š${label}`);

      lastKeyForNext = normalizeForNext(key);

      // è¶…çº§è¿‡é‡ï¼šè¿›å…¥ç»ˆå±€ï¼ˆåœè®¡æ—¶+åœæé†’ï¼‰
      if (lastKeyForNext === "11+") {
        enterOverfullState();
        return;
      }

      scheduleNextCheck(NEXT_CHECK_MS);
    }

    function enterOverfullState() {
      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      isWaitingForChoice = false;
      closeChoiceSheet();

      eatingScreen.classList.add('hidden');
      overfullScreen.classList.remove('hidden');

      endBtnLabel.textContent = "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå·²æš‚åœï¼‰";
    }

    // ====== é‡ç½®å›åˆå§‹ï¼ˆä½ è¦çš„ï¼šé•¿æŒ‰ç»“æŸåç›´æ¥å›å¼€å§‹é¡µï¼‰ ======
    function resetToStart() {
      // æ¸…ç†å®šæ—¶å™¨
      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);

      // çŠ¶æ€å¤ä½
      startTime = null;
      timerInterval = null;
      nextCheckTimeout = null;
      reminderInterval = null;

      lastKeyForNext = "";
      isWaitingForChoice = false;
      hasStarted = false;
      hasEnded = false;

      // UI å¤ä½
      closeChoiceSheet();
      overfullScreen.classList.add('hidden');
      eatingScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');

      timerDisplay.textContent = "å·²ç”¨æ—¶ï¼š00:00";

      // æ¸…ç©ºè®°å½•ï¼ˆä½ å¦‚æœæƒ³ä¿ç•™è®°å½•ï¼ŒæŠŠä¸‹é¢ 3 è¡Œæ³¨é‡Šæ‰ï¼‰
      logList.innerHTML = "";
      logEmpty.classList.remove('hidden');
      recordLog.scrollTop = 0;

      // æŒ‰é’®å¤ä½
      endBtn.disabled = true;
      endBtnLabel.textContent = "é•¿æŒ‰ 1 ç§’ç»“æŸ";
      endProgress.style.transform = "scaleX(0)";
    }

    // ====== å¼€å§‹ ======
    async function startEating() {
      if (hasStarted) return;

      hasStarted = true;
      hasEnded = false;

      startTime = new Date();

      startScreen.classList.add('hidden');
      eatingScreen.classList.remove('hidden');

      // âœ… å…ˆå¯åŠ¨è®¡æ—¶ï¼ˆä¸ä¼šè¢«éŸ³é¢‘å¤±è´¥å½±å“ï¼‰
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      // âœ… è§£é”éŸ³é¢‘ï¼ˆå¿…é¡»ç”±ç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼Œå®‰å“æ›´ç¨³ï¼‰
      await unlockAudio();

      // âœ… è¯•æ’­ä¸€ä¸‹ï¼ˆå¤±è´¥ä¹Ÿä¸å½±å“ï¼‰
      try { playChime(); } catch (_) {}

      scheduleNextCheck(FIRST_CHECK_MS);
      endBtn.disabled = false;

      addLog(`<span class="text-gray-400 font-mono">00åˆ†00ç§’</span> ï¼šå¼€å§‹ç”¨é¤`);
    }

    // ====== é•¿æŒ‰ç»“æŸï¼ˆæ— å¼¹çª—ï¼‰ ======
    function setProgress(p) {
      const clamped = Math.max(0, Math.min(1, p));
      endProgress.style.transform = `scaleX(${clamped})`;
    }

    function finalizeEndAndReset() {
      if (!hasStarted || hasEnded) return;
      hasEnded = true;

      // åœæ‰ä¸€åˆ‡
      clearInterval(timerInterval);
      clearTimeout(nextCheckTimeout);
      clearInterval(reminderInterval);
      closeChoiceSheet();
      isWaitingForChoice = false;

      // è®°å½•ç»“æŸ
      const diff = startTime ? Math.floor((Date.now() - startTime.getTime()) / 1000) : 0;
      const timeStr = `${Math.floor(diff / 60)}åˆ†${diff % 60}ç§’`;
      addLog(`<span class="text-gray-400 font-mono">${timeStr}</span> ï¼šç»“æŸç”¨é¤ âœ…`);

      // ç›´æ¥å›åˆå§‹ï¼ˆç»™ä¸€ç‚¹ç‚¹è§†è§‰ç¼“å†²ï¼‰
      setTimeout(resetToStart, 150);
    }

    function startPress() {
      if (endBtn.disabled) return;
      if (!hasStarted || hasEnded) return;

      pressing = true;
      endBtnLabel.textContent = "ç»§ç»­æŒ‰ä½â€¦";
      softVibrate();

      const start = Date.now();
      setProgress(0);

      pressTimer = setInterval(() => {
        const elapsed = Date.now() - start;
        const p = elapsed / LONG_PRESS_MS;
        setProgress(p);
        if (elapsed >= LONG_PRESS_MS) {
          clearInterval(pressTimer);
          pressTimer = null;
          pressing = false;
          setProgress(1);
          finalizeEndAndReset();
        }
      }, 16);
    }

    function cancelPress() {
      if (!pressing) return;
      pressing = false;

      if (pressTimer) {
        clearInterval(pressTimer);
        pressTimer = null;
      }

      setProgress(0);
      endBtnLabel.textContent = overfullScreen.classList.contains('hidden')
        ? "é•¿æŒ‰ 1 ç§’ç»“æŸ"
        : "é•¿æŒ‰ 1 ç§’ç»“æŸï¼ˆå·²æš‚åœï¼‰";
    }

    // ç»‘å®šï¼štouch/mouse éƒ½å…¼å®¹
    endBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(); }, { passive: false });
    endBtn.addEventListener('touchend', cancelPress);
    endBtn.addEventListener('touchcancel', cancelPress);

    endBtn.addEventListener('mousedown', startPress);
    endBtn.addEventListener('mouseup', cancelPress);
    endBtn.addEventListener('mouseleave', cancelPress);

    // ====== æŠ˜å è®°å½•åŒº ======
    let logCollapsed = false;
    toggleLogBtn.addEventListener('click', () => {
      logCollapsed = !logCollapsed;
      if (logCollapsed) {
        recordLog.classList.add('hidden');
        toggleLogBtn.textContent = 'å±•å¼€';
      } else {
        recordLog.classList.remove('hidden');
        toggleLogBtn.textContent = 'æŠ˜å ';
        recordLog.scrollTop = recordLog.scrollHeight;
      }
    });

    // ç»‘å®šå¼€å§‹æŒ‰é’®
    startBtn.addEventListener('click', startEating);

    // åˆå§‹åŒ–ï¼šç»“æŸæŒ‰é’®ç¦ç”¨
    endBtn.disabled = true;
  </script>
</body>
</html>



