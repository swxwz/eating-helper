<script>
  let startTime;
  let timerInterval;
  let nextCheckTimeout;
  let reminderInterval;
  let lastKeyForNext = ""; // 用“键”驱动下一轮选项

  const logList = document.getElementById('logList');
  const questionBox = document.getElementById('questionBox');
  const optionsContainer = document.getElementById('optionsContainer');

  let isWaitingForChoice = false;

  // ====== 选项配置（用 key，避免中文字符串匹配漏掉）======
  const LABEL = {
    "<5": "5成饱以下",
    "5-6": "5－6成",
    "6-7": "6－7成",
    "7+":  "7成以上",
    "7-8": "7－8成",
    "8-9": "8－9成",
    "8+":  "8成以上",
    "9+":  "9成以上",
    "9-10":"9成－10成",
    "10+": "10成过量",
    "11+": "超级过量"
  };

  // 用户选择后，用这个把“模糊项”归一化，决定下一轮怎么出题
  function normalizeForNext(key) {
    if (key === "7+") return "7-8";  // “7成以上”按 7-8 档处理后续
    if (key === "8+") return "8-9";
    if (key === "9+") return "9-10";
    return key;
  }

  // 根据“上一轮选择(归一化后)”得到下一轮选项（严格按你描述的规则）
  function nextOptionsByLast(lastNormalizedKey) {
    if (!lastNormalizedKey || lastNormalizedKey === "<5") return ["<5", "5-6", "6-7", "7+"];

    if (lastNormalizedKey === "5-6") return ["5-6", "6-7", "7-8", "8+"];
    if (lastNormalizedKey === "6-7") return ["6-7", "7-8", "8-9", "9+"];

    // 你描述：上次 7-8 -> 下次不再包含 7-8
    if (lastNormalizedKey === "7-8") return ["8-9", "9-10", "10+", "11+"];

    // 你没写 8-9 的规则，我这里按“自然衔接”给到：9-10, 10+, 超级过量
    if (lastNormalizedKey === "8-9") return ["9-10", "10+", "11+"];

    if (lastNormalizedKey === "9-10") return ["9-10", "10+", "11+"];
    if (lastNormalizedKey === "10+") return ["10+", "11+"];
    if (lastNormalizedKey === "11+") return ["11+"];

    // 兜底
    return ["9-10", "10+", "11+"];
  }

  // ====== 柔和语音提醒（防排队）======
  function playSoftNotice() {
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel(); // 防止每10秒排队越积越多
    const msg = new SpeechSynthesisUtterance("请问你现在几成饱了？");
    msg.rate = 0.85;
    msg.pitch = 1.0;
    msg.lang = 'zh-CN';
    window.speechSynthesis.speak(msg);
  }

  function scheduleNextCheck(ms) {
    clearTimeout(nextCheckTimeout);
    nextCheckTimeout = setTimeout(triggerCheck, ms);
  }

  function startEating() {
    startTime = new Date();
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('eatingScreen').classList.remove('hidden');

    timerInterval = setInterval(updateTimer, 1000);

    // 第一次：3分钟
    scheduleNextCheck(18000);
  }

  function updateTimer() {
    const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
    const m = String(Math.floor(diff / 60)).padStart(2, '0');
    const s = String(diff % 60).padStart(2, '0');
    document.getElementById('timerDisplay').innerText = `已用时：${m}:${s}`;
  }

  function renderOptions() {
    const options = nextOptionsByLast(lastKeyForNext);
    optionsContainer.innerHTML = '';
    options.forEach(key => {
      const btn = document.createElement('button');
      btn.className = "bg-white border-2 border-orange-200 py-3 rounded-xl shadow-sm active:bg-orange-100 transition";
      btn.innerText = LABEL[key] || key;
      btn.onclick = () => makeChoice(key);
      optionsContainer.appendChild(btn);
    });
  }

  function triggerCheck() {
    if (isWaitingForChoice) return; // 防止重复触发叠加
    isWaitingForChoice = true;
    questionBox.classList.remove('hidden');

    renderOptions();

    clearInterval(reminderInterval);
    reminderInterval = setInterval(() => {
      if (isWaitingForChoice) playSoftNotice();
    }, 10000);

    playSoftNotice();
  }

  function makeChoice(key) {
    const label = LABEL[key] || key;

    isWaitingForChoice = false;
    questionBox.classList.add('hidden');
    clearInterval(reminderInterval);

    // 记录时间戳
    const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
    const timeStr = `${Math.floor(diff / 60)}分${diff % 60}秒`;

    const li = document.createElement('li');
    li.innerHTML = `<span class="text-orange-500 font-mono">${timeStr}</span> : ${label}`;
    logList.prepend(li);

    // 更新“用于下一轮出题”的 key
    lastKeyForNext = normalizeForNext(key);

    if (lastKeyForNext === "11+") {
      alert("检测到已达到超级过量，建议停止进食哦。");
      // 也可以选择：到达最终状态后不再提醒
      // return;
    }

    // 下一次：2分钟
    scheduleNextCheck(12000);
  }

  function stopEating() {
    if (!confirm("确定结束用餐吗？")) return;
    clearInterval(timerInterval);
    clearTimeout(nextCheckTimeout);
    clearInterval(reminderInterval);
    location.reload();
  }
</script>
